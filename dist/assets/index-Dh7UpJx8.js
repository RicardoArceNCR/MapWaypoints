(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const m of s)if(m.type==="childList")for(const v of m.addedNodes)v.tagName==="LINK"&&v.rel==="modulepreload"&&a(v)}).observe(document,{childList:!0,subtree:!0});function e(s){const m={};return s.integrity&&(m.integrity=s.integrity),s.referrerPolicy&&(m.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?m.credentials="include":s.crossOrigin==="anonymous"?m.credentials="omit":m.credentials="same-origin",m}function a(s){if(s.ep)return;s.ep=!0;const m=e(s);fetch(s.href,m)}})();const ye=[{id:"fase1",label:"Fase 1",color:"#1BC6EB",maps:["mapa_f1"]},{id:"fase2",label:"Fase 2",color:"#FF6B6B",maps:["mapa_f2"]},{id:"fase3",label:"Fase 3",color:"#4ECDC4",maps:["mapa_f3"]}],De={mapa_f1:{id:"mapa_f1",name:"Recorrido 1",phase:"fase1",mapImage:{mobile:{src:"/assets/mapa-mobile.jpg",logicalW:2338,logicalH:2779},desktop:{src:"/assets/mapa-dektop.jpg",logicalW:2858,logicalH:1761},useNaturalSize:!1},waypoints:[{mobile:{xp:.13,yp:.19,z:.3},desktop:{xp:.299,yp:.26,z:.88},label:"Inicio del Viaje",lines:["AquÃ­ comienza la historia. Un punto de partida crucial que marca el inicio de esta aventura.","Los detalles de este momento son fundamentales para entender todo lo que viene despuÃ©s."]},{mobile:{xp:.5,yp:.25,z:.1},desktop:{xp:.75,yp:.25,z:.91},label:"Punto Central",lines:["En el corazÃ³n del territorio encontramos este lugar estratÃ©gico.","Desde aquÃ­ se pueden observar todos los acontecimientos importantes."]},{mobile:{xp:.82,yp:.25,z:.01},desktop:{xp:.26,yp:.75,z:.91},label:"Momento Culminante",lines:["Este es el punto donde todo cambia. Un momento decisivo en la narrativa.","Los eventos que ocurren aquÃ­ tienen consecuencias duraderas."]},{mobile:{xp:.82,yp:.8,z:-.02},desktop:{xp:.75,yp:.75,z:.91},label:"Momento Culminante",lines:["Este es el punto donde todo cambia. Un momento decisivo en la narrativa.","Los eventos que ocurren aquÃ­ tienen consecuencias duraderas."]},{mobile:{xp:.82,yp:.25,z:.01},desktop:{xp:.26,yp:1.2,z:.91},label:"Momento Culminanteeeee",lines:["Este es el punto donde eeeeeeeeeeeetodo cambia. Un momento decisivo en la narrativa.","Los eventos que ocurren aquÃ­ tienen consecuencias duraderas."]},{mobile:{xp:.82,yp:.25,z:.01},desktop:{xp:.725,yp:1.25,z:.91},label:"mmmmmMomento Culminanteeeee",lines:["Este esu748484484884 el punto donde eeeeeeeeeeeetodo cambia. Un momento decisivo en la narrativa.","Los eventos que ocurren aquÃ­ tienen consecuencias duraderas."]}],icons:{0:[{type:"hotspot",mobile:{offsetX:33,offsetY:21,width:290,height:176,rotation:6.5},desktop:{offsetX:-482,offsetY:-55,width:388,height:230,rotation:-10},title:"Llegada al Aeropuerto",image:"/assets/mapa-1.jpg",datetime:{date:"15/06/2025",time:"12:07",timeColor:"#FF4444"},location:"Aeropuerto Juan SantamarÃ­a (SJO), Alajuela.",description:"Roberto Danilo Samcam Ruiz regresa a Costa Rica desde MÃ©xico. No se observan personas o situaciones sospechosas en su permanencia en San JosÃ©. Sale en taxi formal (Taxi Tap) hacia su vivienda, conducido por JosÃ© Roberto Naranjo GonzÃ¡lez.",involved:[{id:"person1",name:"Persona #1",avatar:"./assets/persona_1-1.png",role:"Pasajero"},{id:"person2",name:"Persona #2",avatar:"./assets/persona_1-2.png",role:"Conductor",highlighted:!0},{id:"person3",name:"Persona #3",avatar:"./assets/persona_1-3.png",role:"Testigo"}],echos:{person2:[{datetime:{date:"15/06/2025",time:"12:07"},description:"Roberto Danilo Samcam Ruiz regresa a Costa Rica desde MÃ©xico. No se observan personas o situaciones sospechosas."},{datetime:{date:"15/06/2025",time:"14:30"},description:"Segunda interacciÃ³n documentada con el conductor en zona residencial."}],person1:[{datetime:{date:"15/06/2025",time:"11:45"},description:"Arribo del vuelo internacional desde Ciudad de MÃ©xico."}],person3:[{datetime:{date:"15/06/2025",time:"12:10"},description:"ObservaciÃ³n del proceso de abordaje del taxi desde zona de espera."}]}},{type:"hotspot",mobile:{offsetX:54,offsetY:342,width:221,height:183,rotation:-8.2,radius:0},desktop:{offsetX:-115,offsetY:-101,width:150,height:156,rotation:25},title:"Encuentro en Zona Residencial",image:"/assets/mapa-1.jpg",datetime:{date:"16/06/2025",time:"18:45",timeColor:"#FF4444"},location:"Barrio Escalante, San JosÃ©.",description:"Se documenta un segundo encuentro en zona residencial. Los participantes mantienen conversaciÃ³n de aproximadamente 15 minutos en establecimiento comercial. No se detectan comportamientos irregulares durante la observaciÃ³n.",involved:[{id:"person4",name:"Persona #4",avatar:"./assets/persona_1-4.png",role:"Contacto principal"},{id:"person5",name:"Persona #5",avatar:"./assets/persona_1-1.png",role:"AcompaÃ±ante",highlighted:!0},{id:"person6",name:"Persona #6",avatar:"./assets/persona_1-2.png",role:"Tercero presente"},{id:"person7",name:"Persona #7",avatar:"./assets/persona_1-3.png",role:"Observador"}],echos:{person4:[{datetime:{date:"16/06/2025",time:"18:30"},description:"Llegada al establecimiento comercial. Se observa actitud relajada y comportamiento normal."},{datetime:{date:"16/06/2025",time:"19:00"},description:"Salida del establecimiento. Se dirige hacia vehÃ­culo estacionado en zona lateral."}],person5:[{datetime:{date:"16/06/2025",time:"18:45"},description:"Ingreso al establecimiento aproximadamente 5 minutos despuÃ©s del contacto principal."},{datetime:{date:"16/06/2025",time:"19:05"},description:"Permanece en el lugar despuÃ©s de la salida del contacto principal."}],person6:[{datetime:{date:"16/06/2025",time:"18:50"},description:"Participa brevemente en la conversaciÃ³n. DuraciÃ³n aproximada: 3 minutos."}],person7:[{datetime:{date:"16/06/2025",time:"18:40"},description:"Se mantiene en las inmediaciones durante todo el evento documentado."}]}},{type:"hotspot",mobile:{offsetX:281,offsetY:-176,width:70,height:70,rotation:15,radius:37},desktop:{offsetX:-1,offsetY:-96,width:160,height:160,radius:10,rotation:-10},title:"Documento",body:"Un documento importante encontrado en esta ubicaciÃ³n."},{type:"hotspot",mobile:{offsetX:300,offsetY:540,width:83,height:83,radius:30,rotation:0},desktop:{offsetX:-1,offsetY:142,width:260,height:160,radius:10,rotation:0},title:"Contexto GeogrÃ¡fico",body:"UbicaciÃ³n especÃ­fica y detalles del entorno. CaracterÃ­sticas del lugar que influyen en los acontecimientos."}],1:[{type:"hotspot",mobile:{offsetX:-60,offsetY:-80,width:136,height:136,rotation:0},desktop:{offsetX:-90,offsetY:-90,width:136,height:136,rotation:0},title:"EvoluciÃ³n del Personaje",body:"CÃ³mo ha cambiado el protagonista desde el inicio. Nuevas perspectivas y aprendizajes adquiridos."},{type:"hotspot",mobile:{offsetX:60,offsetY:-80,width:136,height:136,rotation:0},desktop:{offsetX:90,offsetY:-90,width:136,height:136,rotation:0},title:"Nuevos Encuentros",body:"Personas que aparecen en este punto central. Su papel en el desarrollo de los eventos."},{type:"hotspot",mobile:{offsetX:-60,offsetY:80,width:136,height:136,rotation:0},desktop:{offsetX:-90,offsetY:90,width:136,height:136,rotation:0},title:"Elementos Descubiertos",body:"Nuevos objetos y recursos encontrados. Su utilidad y significado en esta etapa del viaje."},{type:"hotspot",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:80,width:136,height:136,rotation:0},desktop:{offsetX:90,offsetY:90,width:136,height:136,rotation:0},title:"Zona EstratÃ©gica",body:"Importancia tÃ¡ctica de esta ubicaciÃ³n. Ventajas y desafÃ­os que presenta el terreno."}],2:[{type:"hotspot",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:-80,width:136,height:136,rotation:0},desktop:{offsetX:-90,offsetY:-90,width:136,height:136,rotation:0},title:"TransformaciÃ³n Final",body:"El estado final del personaje. CÃ³mo los acontecimientos han definido su destino."},{type:"hotspot",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:-80,width:136,height:136,rotation:0},desktop:{offsetX:90,offsetY:-90,width:136,height:136,rotation:0},title:"Testigos del Desenlace",body:"QuiÃ©nes estÃ¡n presentes en este momento crucial. Su reacciÃ³n ante los eventos finales."},{type:"hotspot",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:80,width:136,height:136,rotation:0},desktop:{offsetX:-90,offsetY:90,width:136,height:136,rotation:0},title:"Legado Material",body:"Objetos que permanecen como testimonio. Evidencia fÃ­sica de todo lo ocurrido."},{type:"hotspot",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:80,width:136,height:136,rotation:0},desktop:{offsetX:90,offsetY:90,width:136,height:136,rotation:0},title:"Lugar del Destino",body:"El significado final de esta ubicaciÃ³n. Por quÃ© todo termina precisamente aquÃ­."}],3:[{type:"hotspot",img:"/assets/mapa-1.jpg",mobile:{offsetX:-60,offsetY:-80,width:720,height:280,rotation:10},desktop:{offsetX:-90,offsetY:-90,width:950,height:900,rotation:-15},title:"Mapa del Territorio",body:"Vista detallada de la zona completa. Este mapa muestra todos los lugares visitados."},{type:"hotspot",mobile:{offsetX:60,offsetY:-80,width:130,height:130,rotation:0},desktop:{offsetX:90,offsetY:-90,width:136,height:136,rotation:0},title:"Testigos del Desenlace",body:"QuiÃ©nes estÃ¡n presentes en este momento crucial. Su reacciÃ³n ante los eventos finales."},{type:"hotspot",mobile:{offsetX:-60,offsetY:80,width:100,height:180,radius:10},desktop:{offsetX:-90,offsetY:90,width:150,height:120,radius:10},title:"Legado Material",body:"Objetos que permanecen como testimonio. Evidencia fÃ­sica de todo lo ocurrido."},{type:"hotspot",mobile:{offsetX:60,offsetY:80,width:136,height:136,rotation:0},desktop:{offsetX:90,offsetY:90,width:130,height:90,rotation:0},title:"Lugar del Destino",body:"El significado final de esta ubicaciÃ³n. Por quÃ© todo termina precisamente aquÃ­."}],4:[{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:-80,width:36,height:36,rotation:0},desktop:{offsetX:-90,offsetY:-90,width:36,height:36,rotation:0},title:"ReflexiÃ³n Final",body:"El momento de entender todo lo vivido. Un espacio para procesar."},{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:-80,width:36,height:36,rotation:0},desktop:{offsetX:90,offsetY:-90,width:36,height:36,rotation:0},title:"Testigos del Final",body:"QuiÃ©nes presencian el momento culminante. Su rol en la conclusiÃ³n."},{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:80,width:36,height:36,rotation:0},desktop:{offsetX:-90,offsetY:90,width:36,height:36,rotation:0},title:"SÃ­mbolos del Cierre",body:"Objetos que representan la conclusiÃ³n. Su significado simbÃ³lico final."},{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:80,width:36,height:36,rotation:0},desktop:{offsetX:90,offsetY:90,width:36,height:36,rotation:0},title:"Centro del Desenlace",body:"El punto exacto donde todo converge y se resuelve."}],5:[{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:-80,width:36,height:36,rotation:0},desktop:{offsetX:-90,offsetY:-90,width:36,height:36,rotation:0},title:"DespuÃ©s de Todo",body:"CÃ³mo termina el protagonista despuÃ©s de esta experiencia. Su estado final."},{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:-80,width:36,height:36,rotation:0},desktop:{offsetX:90,offsetY:-90,width:36,height:36,rotation:0},title:"Vidas Transformadas",body:"CÃ³mo han cambiado todas las personas involucradas. El impacto duradero."},{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:80,width:36,height:36,rotation:0},desktop:{offsetX:-90,offsetY:90,width:36,height:36,rotation:0},title:"Memoria Tangible",body:"Lo que permanece fÃ­sicamente como recordatorio de toda la historia."},{type:"icon",img:"/assets/icon-info.png",mobile:{offsetX:60,offsetY:80,width:36,height:36,rotation:0},desktop:{offsetX:90,offsetY:90,width:36,height:36,rotation:0},title:"Lugar de ReflexiÃ³n",body:"El Ãºltimo lugar donde la historia se contempla. Un espacio para entender todo lo vivido."}]}},mapa_f2:{id:"mapa_f2",name:"Recorrido 2",phase:"fase2",mapImage:{mobile:{src:"/assets/mapa-mobile-2.jpg",logicalW:2338,logicalH:2779},desktop:{src:"/assets/mapa-dektop-2.jpg",logicalW:2858,logicalH:1761},useNaturalSize:!1},waypoints:[{mobile:{xp:.13,yp:.19,z:.3},desktop:{xp:.299,yp:.26,z:.88},label:"Inicio del Viaje",lines:["AquÃ­ comienza la historia. Un punto de partida crucial que marca el inicio de esta aventura.","Los detalles de este momento son fundamentales para entender todo lo que viene despuÃ©s."]},{mobile:{xp:.5,yp:.25,z:.1},desktop:{xp:.75,yp:.25,z:.91},label:"Punto Central",lines:["En el corazÃ³n del territorio encontramos este lugar estratÃ©gico.","Desde aquÃ­ se pueden observar todos los acontecimientos importantes."]},{mobile:{xp:.82,yp:.25,z:.01},desktop:{xp:.26,yp:.75,z:.91},label:"Momento Culminante",lines:["Este es el punto donde todo cambia. Un momento decisivo en la narrativa.","Los eventos que ocurren aquÃ­ tienen consecuencias duraderas."]},{mobile:{xp:.82,yp:.8,z:-.02},desktop:{xp:.75,yp:.75,z:.91},label:"Momento Culminante",lines:["Este es el punto donde todo cambia. Un momento decisivo en la narrativa.","Los eventos que ocurren aquÃ­ tienen consecuencias duraderas."]},{mobile:{xp:.82,yp:.25,z:.01},desktop:{xp:.26,yp:1.2,z:.91},label:"Momento Culminanteeeee",lines:["Este es el punto donde eeeeeeeeeeeetodo cambia. Un momento decisivo en la narrativa.","Los eventos que ocurren aquÃ­ tienen consecuencias duraderas."]},{mobile:{xp:.82,yp:.25,z:.01},desktop:{xp:.725,yp:1.25,z:.91},label:"mmmmmMomento Culminanteeeee",lines:["Este esu748484484884 el punto donde eeeeeeeeeeeetodo cambia. Un momento decisivo en la narrativa.","Los eventos que ocurren aquÃ­ tienen consecuencias duraderas."]}],icons:{0:[{type:"hotspot",mobile:{offsetX:33,offsetY:21,width:290,height:176,rotation:6.5},desktop:{offsetX:-482,offsetY:-55,width:388,height:230,rotation:-10},title:"Llegada al Aeropuerto",image:"/assets/mapa-1.jpg",datetime:{date:"15/06/2025",time:"12:07",timeColor:"#FF4444"},location:"Aeropuerto Juan SantamarÃ­a (SJO), Alajuela.",description:"Roberto Danilo Samcam Ruiz regresa a Costa Rica desde MÃ©xico. No se observan personas o situaciones sospechosas en su permanencia en San JosÃ©. Sale en taxi formal (Taxi Tap) hacia su vivienda, conducido por JosÃ© Roberto Naranjo GonzÃ¡lez.",involved:[{id:"person1",name:"Persona #1",avatar:"./assets/persona_1-1.png",role:"Pasajero"},{id:"person2",name:"Persona #2",avatar:"./assets/persona_1-2.png",role:"Conductor",highlighted:!0},{id:"person3",name:"Persona #3",avatar:"./assets/persona_1-3.png",role:"Testigo"}],echos:{person2:[{datetime:{date:"15/06/2025",time:"12:07"},description:"Roberto Danilo Samcam Ruiz regresa a Costa Rica desde MÃ©xico. No se observan personas o situaciones sospechosas."},{datetime:{date:"15/06/2025",time:"14:30"},description:"Segunda interacciÃ³n documentada con el conductor en zona residencial."}],person1:[{datetime:{date:"15/06/2025",time:"11:45"},description:"Arribo del vuelo internacional desde Ciudad de MÃ©xico."}],person3:[{datetime:{date:"15/06/2025",time:"12:10"},description:"ObservaciÃ³n del proceso de abordaje del taxi desde zona de espera."}]}},{type:"hotspot",mobile:{offsetX:54,offsetY:342,width:221,height:183,rotation:-8.2,radius:0},desktop:{offsetX:-115,offsetY:-101,width:150,height:156,rotation:25},title:"Encuentro en Zona Residencial",image:"/assets/mapa-1.jpg",datetime:{date:"16/06/2025",time:"18:45",timeColor:"#FF4444"},location:"Barrio Escalante, San JosÃ©.",description:"Se documenta un segundo encuentro en zona residencial. Los participantes mantienen conversaciÃ³n de aproximadamente 15 minutos en establecimiento comercial. No se detectan comportamientos irregulares durante la observaciÃ³n.",involved:[{id:"person4",name:"Persona #4",avatar:"./assets/persona_1-4.png",role:"Contacto principal"},{id:"person5",name:"Persona #5",avatar:"./assets/persona_1-1.png",role:"AcompaÃ±ante",highlighted:!0},{id:"person6",name:"Persona #6",avatar:"./assets/persona_1-2.png",role:"Tercero presente"},{id:"person7",name:"Persona #7",avatar:"./assets/persona_1-3.png",role:"Observador"}],echos:{person4:[{datetime:{date:"16/06/2025",time:"18:30"},description:"Llegada al establecimiento comercial. Se observa actitud relajada y comportamiento normal."},{datetime:{date:"16/06/2025",time:"19:00"},description:"Salida del establecimiento. Se dirige hacia vehÃ­culo estacionado en zona lateral."}],person5:[{datetime:{date:"16/06/2025",time:"18:45"},description:"Ingreso al establecimiento aproximadamente 5 minutos despuÃ©s del contacto principal."},{datetime:{date:"16/06/2025",time:"19:05"},description:"Permanece en el lugar despuÃ©s de la salida del contacto principal."}],person6:[{datetime:{date:"16/06/2025",time:"18:50"},description:"Participa brevemente en la conversaciÃ³n. DuraciÃ³n aproximada: 3 minutos."}],person7:[{datetime:{date:"16/06/2025",time:"18:40"},description:"Se mantiene en las inmediaciones durante todo el evento documentado."}]}},{type:"hotspot",mobile:{offsetX:281,offsetY:-176,width:70,height:70,rotation:15,radius:37},desktop:{offsetX:-1,offsetY:-96,width:160,height:160,radius:10,rotation:-10},title:"Documento",body:"Un documento importante encontrado en esta ubicaciÃ³n."},{type:"hotspot",mobile:{offsetX:300,offsetY:540,width:83,height:83,radius:30,rotation:0},desktop:{offsetX:-1,offsetY:142,width:260,height:160,radius:10,rotation:0},title:"Contexto GeogrÃ¡fico",body:"UbicaciÃ³n especÃ­fica y detalles del entorno. CaracterÃ­sticas del lugar que influyen en los acontecimientos."}],1:[{type:"hotspot",mobile:{offsetX:-60,offsetY:-80,width:136,height:136,rotation:0},desktop:{offsetX:-90,offsetY:-90,width:136,height:136,rotation:0},title:"EvoluciÃ³n del Personaje",body:"CÃ³mo ha cambiado el protagonista desde el inicio. Nuevas perspectivas y aprendizajes adquiridos."},{type:"hotspot",mobile:{offsetX:60,offsetY:-80,width:136,height:136,rotation:0},desktop:{offsetX:90,offsetY:-90,width:136,height:136,rotation:0},title:"Nuevos Encuentros",body:"Personas que aparecen en este punto central. Su papel en el desarrollo de los eventos."},{type:"hotspot",mobile:{offsetX:-60,offsetY:80,width:136,height:136,rotation:0},desktop:{offsetX:-90,offsetY:90,width:136,height:136,rotation:0},title:"Elementos Descubiertos",body:"Nuevos objetos y recursos encontrados. Su utilidad y significado en esta etapa del viaje."},{type:"hotspot",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:80,width:136,height:136,rotation:0},desktop:{offsetX:90,offsetY:90,width:136,height:136,rotation:0},title:"Zona EstratÃ©gica",body:"Importancia tÃ¡ctica de esta ubicaciÃ³n. Ventajas y desafÃ­os que presenta el terreno."}],2:[{type:"hotspot",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:-80,width:136,height:136,rotation:0},desktop:{offsetX:-90,offsetY:-90,width:136,height:136,rotation:0},title:"TransformaciÃ³n Final",body:"El estado final del personaje. CÃ³mo los acontecimientos han definido su destino."},{type:"hotspot",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:-80,width:136,height:136,rotation:0},desktop:{offsetX:90,offsetY:-90,width:136,height:136,rotation:0},title:"Testigos del Desenlace",body:"QuiÃ©nes estÃ¡n presentes en este momento crucial. Su reacciÃ³n ante los eventos finales."},{type:"hotspot",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:80,width:136,height:136,rotation:0},desktop:{offsetX:-90,offsetY:90,width:136,height:136,rotation:0},title:"Legado Material",body:"Objetos que permanecen como testimonio. Evidencia fÃ­sica de todo lo ocurrido."},{type:"hotspot",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:80,width:136,height:136,rotation:0},desktop:{offsetX:90,offsetY:90,width:136,height:136,rotation:0},title:"Lugar del Destino",body:"El significado final de esta ubicaciÃ³n. Por quÃ© todo termina precisamente aquÃ­."}],3:[{type:"hotspot",img:"/assets/mapa-1.jpg",mobile:{offsetX:-60,offsetY:-80,width:720,height:280,rotation:10},desktop:{offsetX:-90,offsetY:-90,width:950,height:900,rotation:-15},title:"Mapa del Territorio",body:"Vista detallada de la zona completa. Este mapa muestra todos los lugares visitados."},{type:"hotspot",mobile:{offsetX:60,offsetY:-80,width:130,height:130,rotation:0},desktop:{offsetX:90,offsetY:-90,width:136,height:136,rotation:0},title:"Testigos del Desenlace",body:"QuiÃ©nes estÃ¡n presentes en este momento crucial. Su reacciÃ³n ante los eventos finales."},{type:"hotspot",mobile:{offsetX:-60,offsetY:80,width:100,height:180,radius:10},desktop:{offsetX:-90,offsetY:90,width:150,height:120,radius:10},title:"Legado Material",body:"Objetos que permanecen como testimonio. Evidencia fÃ­sica de todo lo ocurrido."},{type:"hotspot",mobile:{offsetX:60,offsetY:80,width:136,height:136,rotation:0},desktop:{offsetX:90,offsetY:90,width:130,height:90,rotation:0},title:"Lugar del Destino",body:"El significado final de esta ubicaciÃ³n. Por quÃ© todo termina precisamente aquÃ­."}],4:[{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:-80,width:36,height:36,rotation:0},desktop:{offsetX:-90,offsetY:-90,width:36,height:36,rotation:0},title:"ReflexiÃ³n Final",body:"El momento de entender todo lo vivido. Un espacio para procesar."},{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:-80,width:36,height:36,rotation:0},desktop:{offsetX:90,offsetY:-90,width:36,height:36,rotation:0},title:"Testigos del Final",body:"QuiÃ©nes presencian el momento culminante. Su rol en la conclusiÃ³n."},{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:80,width:36,height:36,rotation:0},desktop:{offsetX:-90,offsetY:90,width:36,height:36,rotation:0},title:"SÃ­mbolos del Cierre",body:"Objetos que representan la conclusiÃ³n. Su significado simbÃ³lico final."},{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:80,width:36,height:36,rotation:0},desktop:{offsetX:90,offsetY:90,width:36,height:36,rotation:0},title:"Centro del Desenlace",body:"El punto exacto donde todo converge y se resuelve."}],5:[{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:-80,width:36,height:36,rotation:0},desktop:{offsetX:-90,offsetY:-90,width:36,height:36,rotation:0},title:"DespuÃ©s de Todo",body:"CÃ³mo termina el protagonista despuÃ©s de esta experiencia. Su estado final."},{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:-80,width:36,height:36,rotation:0},desktop:{offsetX:90,offsetY:-90,width:36,height:36,rotation:0},title:"Vidas Transformadas",body:"CÃ³mo han cambiado todas las personas involucradas. El impacto duradero."},{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:80,width:36,height:36,rotation:0},desktop:{offsetX:-90,offsetY:90,width:36,height:36,rotation:0},title:"Memoria Tangible",body:"Lo que permanece fÃ­sicamente como recordatorio de toda la historia."},{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:80,width:36,height:36,rotation:0},desktop:{offsetX:90,offsetY:90,width:36,height:36,rotation:0},title:"Lugar de ReflexiÃ³n",body:"El Ãºltimo lugar donde la historia se contempla. Un espacio para entender todo lo vivido."}]}},mapa_f3:{id:"mapa_f3",name:"Recorrido 3",phase:"fase3",mapImage:{mobile:{src:"/assets/mapa-mobile-3.jpg",logicalW:2338,logicalH:2779},desktop:{src:"/assets/mapa-dektop-3.jpg",logicalW:2858,logicalH:1761},useNaturalSize:!1},waypoints:[{mobile:{xp:.13,yp:.19,z:.3},desktop:{xp:.299,yp:.26,z:.88},label:"Inicio del Viaje",lines:["AquÃ­ comienza la historia. Un punto de partida crucial que marca el inicio de esta aventura.","Los detalles de este momento son fundamentales para entender todo lo que viene despuÃ©s."]},{mobile:{xp:.5,yp:.25,z:.1},desktop:{xp:.75,yp:.25,z:.91},label:"Punto Central",lines:["En el corazÃ³n del territorio encontramos este lugar estratÃ©gico.","Desde aquÃ­ se pueden observar todos los acontecimientos importantes."]},{mobile:{xp:.82,yp:.25,z:.01},desktop:{xp:.26,yp:.75,z:.91},label:"Momento Culminante",lines:["Este es el punto donde todo cambia. Un momento decisivo en la narrativa.","Los eventos que ocurren aquÃ­ tienen consecuencias duraderas."]},{mobile:{xp:.82,yp:.8,z:-.02},desktop:{xp:.75,yp:.75,z:.91},label:"Momento Culminante",lines:["Este es el punto donde todo cambia. Un momento decisivo en la narrativa.","Los eventos que ocurren aquÃ­ tienen consecuencias duraderas."]},{mobile:{xp:.82,yp:.25,z:.01},desktop:{xp:.26,yp:1.2,z:.91},label:"Momento Culminanteeeee",lines:["Este es el punto donde eeeeeeeeeeeetodo cambia. Un momento decisivo en la narrativa.","Los eventos que ocurren aquÃ­ tienen consecuencias duraderas."]},{mobile:{xp:.82,yp:.25,z:.01},desktop:{xp:.725,yp:1.25,z:.91},label:"mmmmmMomento Culminanteeeee",lines:["Este esu748484484884 el punto donde eeeeeeeeeeeetodo cambia. Un momento decisivo en la narrativa.","Los eventos que ocurren aquÃ­ tienen consecuencias duraderas."]}],icons:{0:[{type:"hotspot",mobile:{offsetX:33,offsetY:21,width:290,height:176,rotation:6.5},desktop:{offsetX:-482,offsetY:-55,width:388,height:230,rotation:-10},title:"Llegada al Aeropuerto",image:"/assets/mapa-1.jpg",datetime:{date:"15/06/2025",time:"12:07",timeColor:"#FF4444"},location:"Aeropuerto Juan SantamarÃ­a (SJO), Alajuela.",description:"Roberto Danilo Samcam Ruiz regresa a Costa Rica desde MÃ©xico. No se observan personas o situaciones sospechosas en su permanencia en San JosÃ©. Sale en taxi formal (Taxi Tap) hacia su vivienda, conducido por JosÃ© Roberto Naranjo GonzÃ¡lez.",involved:[{id:"person1",name:"Persona #1",avatar:"/assets/persona_1-1.png",role:"Pasajero"},{id:"person2",name:"Persona #2",avatar:"./assets/persona_1-2.png",role:"Conductor",highlighted:!0},{id:"person3",name:"Persona #3",avatar:"./assets/persona_1-3.png",role:"Testigo"}],echos:{person2:[{datetime:{date:"15/06/2025",time:"12:07"},description:"Roberto Danilo Samcam Ruiz regresa a Costa Rica desde MÃ©xico. No se observan personas o situaciones sospechosas."},{datetime:{date:"15/06/2025",time:"14:30"},description:"Segunda interacciÃ³n documentada con el conductor en zona residencial."}],person1:[{datetime:{date:"15/06/2025",time:"11:45"},description:"Arribo del vuelo internacional desde Ciudad de MÃ©xico."}],person3:[{datetime:{date:"15/06/2025",time:"12:10"},description:"ObservaciÃ³n del proceso de abordaje del taxi desde zona de espera."}]}},{type:"hotspot",mobile:{offsetX:54,offsetY:342,width:221,height:183,rotation:-8.2,radius:0},desktop:{offsetX:-115,offsetY:-101,width:150,height:156,rotation:25},title:"Encuentro en Zona Residencial",image:"/assets/mapa-1.jpg",datetime:{date:"16/06/2025",time:"18:45",timeColor:"#FF4444"},location:"Barrio Escalante, San JosÃ©.",description:"Se documenta un segundo encuentro en zona residencial. Los participantes mantienen conversaciÃ³n de aproximadamente 15 minutos en establecimiento comercial. No se detectan comportamientos irregulares durante la observaciÃ³n.",involved:[{id:"person4",name:"Persona #4",avatar:"./assets/persona_1-4.png",role:"Contacto principal"},{id:"person5",name:"Persona #5",avatar:"./assets/persona_1-1.png",role:"AcompaÃ±ante",highlighted:!0},{id:"person6",name:"Persona #6",avatar:"./assets/persona_1-2.png",role:"Tercero presente"},{id:"person7",name:"Persona #7",avatar:"./assets/persona_1-3.png",role:"Observador"}],echos:{person4:[{datetime:{date:"16/06/2025",time:"18:30"},description:"Llegada al establecimiento comercial. Se observa actitud relajada y comportamiento normal."},{datetime:{date:"16/06/2025",time:"19:00"},description:"Salida del establecimiento. Se dirige hacia vehÃ­culo estacionado en zona lateral."}],person5:[{datetime:{date:"16/06/2025",time:"18:45"},description:"Ingreso al establecimiento aproximadamente 5 minutos despuÃ©s del contacto principal."},{datetime:{date:"16/06/2025",time:"19:05"},description:"Permanece en el lugar despuÃ©s de la salida del contacto principal."}],person6:[{datetime:{date:"16/06/2025",time:"18:50"},description:"Participa brevemente en la conversaciÃ³n. DuraciÃ³n aproximada: 3 minutos."}],person7:[{datetime:{date:"16/06/2025",time:"18:40"},description:"Se mantiene en las inmediaciones durante todo el evento documentado."}]}},{type:"hotspot",mobile:{offsetX:281,offsetY:-176,width:70,height:70,rotation:15,radius:37},desktop:{offsetX:-1,offsetY:-96,width:160,height:160,radius:10,rotation:-10},title:"Documento",body:"Un documento importante encontrado en esta ubicaciÃ³n."},{type:"hotspot",mobile:{offsetX:300,offsetY:540,width:83,height:83,radius:30,rotation:0},desktop:{offsetX:-1,offsetY:142,width:260,height:160,radius:10,rotation:0},title:"Contexto GeogrÃ¡fico",body:"UbicaciÃ³n especÃ­fica y detalles del entorno. CaracterÃ­sticas del lugar que influyen en los acontecimientos."}],1:[{type:"hotspot",mobile:{offsetX:-60,offsetY:-80,width:136,height:136,rotation:0},desktop:{offsetX:-90,offsetY:-90,width:136,height:136,rotation:0},title:"EvoluciÃ³n del Personaje",body:"CÃ³mo ha cambiado el protagonista desde el inicio. Nuevas perspectivas y aprendizajes adquiridos."},{type:"hotspot",mobile:{offsetX:60,offsetY:-80,width:136,height:136,rotation:0},desktop:{offsetX:90,offsetY:-90,width:136,height:136,rotation:0},title:"Nuevos Encuentros",body:"Personas que aparecen en este punto central. Su papel en el desarrollo de los eventos."},{type:"hotspot",mobile:{offsetX:-60,offsetY:80,width:136,height:136,rotation:0},desktop:{offsetX:-90,offsetY:90,width:136,height:136,rotation:0},title:"Elementos Descubiertos",body:"Nuevos objetos y recursos encontrados. Su utilidad y significado en esta etapa del viaje."},{type:"hotspot",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:80,width:136,height:136,rotation:0},desktop:{offsetX:90,offsetY:90,width:136,height:136,rotation:0},title:"Zona EstratÃ©gica",body:"Importancia tÃ¡ctica de esta ubicaciÃ³n. Ventajas y desafÃ­os que presenta el terreno."}],2:[{type:"hotspot",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:-80,width:136,height:136,rotation:0},desktop:{offsetX:-90,offsetY:-90,width:136,height:136,rotation:0},title:"TransformaciÃ³n Final",body:"El estado final del personaje. CÃ³mo los acontecimientos han definido su destino."},{type:"hotspot",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:-80,width:136,height:136,rotation:0},desktop:{offsetX:90,offsetY:-90,width:136,height:136,rotation:0},title:"Testigos del Desenlace",body:"QuiÃ©nes estÃ¡n presentes en este momento crucial. Su reacciÃ³n ante los eventos finales."},{type:"hotspot",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:80,width:136,height:136,rotation:0},desktop:{offsetX:-90,offsetY:90,width:136,height:136,rotation:0},title:"Legado Material",body:"Objetos que permanecen como testimonio. Evidencia fÃ­sica de todo lo ocurrido."},{type:"hotspot",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:80,width:136,height:136,rotation:0},desktop:{offsetX:90,offsetY:90,width:136,height:136,rotation:0},title:"Lugar del Destino",body:"El significado final de esta ubicaciÃ³n. Por quÃ© todo termina precisamente aquÃ­."}],3:[{type:"hotspot",img:"/assets/mapa-1.jpg",mobile:{offsetX:-60,offsetY:-80,width:720,height:280,rotation:10},desktop:{offsetX:-90,offsetY:-90,width:950,height:900,rotation:-15},title:"Mapa del Territorio",body:"Vista detallada de la zona completa. Este mapa muestra todos los lugares visitados."},{type:"hotspot",mobile:{offsetX:60,offsetY:-80,width:130,height:130,rotation:0},desktop:{offsetX:90,offsetY:-90,width:136,height:136,rotation:0},title:"Testigos del Desenlace",body:"QuiÃ©nes estÃ¡n presentes en este momento crucial. Su reacciÃ³n ante los eventos finales."},{type:"hotspot",mobile:{offsetX:-60,offsetY:80,width:100,height:180,radius:10},desktop:{offsetX:-90,offsetY:90,width:150,height:120,radius:10},title:"Legado Material",body:"Objetos que permanecen como testimonio. Evidencia fÃ­sica de todo lo ocurrido."},{type:"hotspot",mobile:{offsetX:60,offsetY:80,width:136,height:136,rotation:0},desktop:{offsetX:90,offsetY:90,width:130,height:90,rotation:0},title:"Lugar del Destino",body:"El significado final de esta ubicaciÃ³n. Por quÃ© todo termina precisamente aquÃ­."}],4:[{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:-80,width:36,height:36,rotation:0},desktop:{offsetX:-90,offsetY:-90,width:36,height:36,rotation:0},title:"ReflexiÃ³n Final",body:"El momento de entender todo lo vivido. Un espacio para procesar."},{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:-80,width:36,height:36,rotation:0},desktop:{offsetX:90,offsetY:-90,width:36,height:36,rotation:0},title:"Testigos del Final",body:"QuiÃ©nes presencian el momento culminante. Su rol en la conclusiÃ³n."},{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:80,width:36,height:36,rotation:0},desktop:{offsetX:-90,offsetY:90,width:36,height:36,rotation:0},title:"SÃ­mbolos del Cierre",body:"Objetos que representan la conclusiÃ³n. Su significado simbÃ³lico final."},{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:80,width:36,height:36,rotation:0},desktop:{offsetX:90,offsetY:90,width:36,height:36,rotation:0},title:"Centro del Desenlace",body:"El punto exacto donde todo converge y se resuelve."}],5:[{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:-80,width:36,height:36,rotation:0},desktop:{offsetX:-90,offsetY:-90,width:36,height:36,rotation:0},title:"DespuÃ©s de Todo",body:"CÃ³mo termina el protagonista despuÃ©s de esta experiencia. Su estado final."},{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:-80,width:36,height:36,rotation:0},desktop:{offsetX:90,offsetY:-90,width:36,height:36,rotation:0},title:"Vidas Transformadas",body:"CÃ³mo han cambiado todas las personas involucradas. El impacto duradero."},{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:-60,offsetY:80,width:36,height:36,rotation:0},desktop:{offsetX:-90,offsetY:90,width:36,height:36,rotation:0},title:"Memoria Tangible",body:"Lo que permanece fÃ­sicamente como recordatorio de toda la historia."},{type:"icon",img:"./assets/icon-info.png",mobile:{offsetX:60,offsetY:80,width:36,height:36,rotation:0},desktop:{offsetX:90,offsetY:90,width:36,height:36,rotation:0},title:"Lugar de ReflexiÃ³n",body:"El Ãºltimo lugar donde la historia se contempla. Un espacio para entender todo lo vivido."}]}}},L={SHOW_DIALOGS:!1,SHOW_CONTROLS:!0,CAMERA_EFFECTS:{breathingEnabled:!1,breathingAmount:9.5,breathingSpeed:9e-4,breathingZAmount:9e-4,transitionEnabled:!0,transitionDuration:1200,transitionZoomOut:.25,transitionEasing:"ease-in-out"},CANVAS_LIMITS:{desktop:{maxWidth:4096,maxHeight:4096,maxPixels:12e6,maxMemoryMB:150},mobile:{maxWidth:2048,maxHeight:4500,maxPixels:8e6,maxMemoryMB:100},downscaleFactor:.8,warnThreshold:.85},WAYPOINT_RENDERING:{enableCulling:!0,cullingMargin:300,maxVisibleWaypoints:20,useSpatialIndex:!0,spatialIndexThreshold:15,cellSize:500},MEMORY_MANAGEMENT:{maxActivePhaseCaches:1,autoCleanInactivePhases:!0,unloadAfterPhaseChange:!0,forceClearCache:!0,logMemoryUsage:!0},MOBILE_OPTIMIZATIONS:{maxDPR:1.5,disableBreathingOnLowEnd:!0,reduceTransitionQuality:!0,targetFPS:45,aggressiveCulling:!0},RESPONSIVE_SIZING:{mobile:{lockItemWidthToScreenPx:!0},desktop:{lockItemWidthToScreenPx:!1}},DEBUG_HOTSPOTS:!0,DEBUG_SHOW_GRID:!0,DEBUG_SHOW_COORDS:!0,DEBUG_SHOW_MINIMAP_MOBILE:!0,DEBUG_SHOW_WAYPOINT_LABELS:!0,DEBUG_SHOW_MEMORY_STATS:!0,DEBUG_SHOW_WAYPOINT_HUD:!0,ICON_STYLES:{showBackground:!0,backgroundColor:"rgba(0, 209, 255, .18)",borderColor:"rgba(255,255,255,.55)",borderWidth:1.5},WAYPOINT_OFFSET:{mobile:0,desktop:0},BASE_W:1280,BASE_H:720,TYPE_SPEED:18,EASE:.08,MARKER_R:8,ICON_R:18,ICON_SIZE:36,DPR_MAX:2,MOBILE_BREAKPOINT:900,CANVAS_MIN_HEIGHT:720,DIALOG_BOX:{x:16,y:500,w:1248,h:180,bg:"rgba(0,0,0,0.55)",border:"rgba(255,255,255,0.18)",radius:14,padding:16,nameColor:"#89e0ff",textColor:"#fff",fontStack:"'Inter', system-ui, -apple-system, Segoe UI, Roboto, sans-serif",nameSize:22,textSize:18,lineHeight:28},CAM:{minZ:.25,maxZ:3.2,defaultZMobile:1.2,defaultZDesktop:.8},PERFORMANCE:{spatialGridSize:200,idleFPS:30,useOffscreenCanvas:!0,prefetchNextWaypoint:!0,autoCleanOldMaps:!0,preferWebP:!0,logPerformanceStats:!0,logMemoryStats:!0},ICON_TRANSITION:{enabled:!0,easingIn:"ease-out",easingOut:"ease-in",durationIn:400,durationOut:300,delayBetweenIcons:50,scaleFrom:.3,opacityFrom:0}};class at{constructor(){this.imageCache=new Map,this.currentPhase=ye[0].id,this.currentMapId=null,this.currentMap=null,this.preloadedMaps=new Set,this.isMobile=this.checkIsMobile(),this.supportsWebP=!1,this.checkWebPSupport(),this.renderedCache=new Map,this.mediaQuery=window.matchMedia(`(max-width: ${L.MOBILE_BREAKPOINT-1}px)`),this.mediaQuery.addEventListener("change",t=>{this.isMobile=t.matches})}checkIsMobile(){return window.matchMedia(`(max-width: ${L.MOBILE_BREAKPOINT-1}px)`).matches}async checkWebPSupport(){if(!("createImageBitmap"in window)){this.supportsWebP=!1;return}const t="data:image/webp;base64,UklGRiQAAABXRUJQVlA4IBgAAAAwAQCdASoBAAEAAwA0JaQAA3AA/vuUAAA=";try{const e=new Image,a=new Promise(s=>{e.onload=()=>s(e.height===1),e.onerror=()=>s(!1)});e.src=t,this.supportsWebP=await a,this.supportsWebP&&console.log("âœ… WebP soportado - imÃ¡genes optimizadas disponibles")}catch{this.supportsWebP=!1}}getOptimizedImagePath(t){return!this.supportsWebP||t.endsWith(".webp")?t:t.replace(/\.(jpg|jpeg|png)$/i,".webp")}loadImage(t,e=null){return new Promise((a,s)=>{const m=e?`${t}_${e}`:t;if(this.imageCache.has(m))return a(this.imageCache.get(m));const v=this.getOptimizedImagePath(t),O=new Image;/^https?:\/\//i.test(v)&&(O.crossOrigin="anonymous");try{O.decoding="async"}catch{}if("loading"in HTMLImageElement.prototype)try{O.loading="eager"}catch{}O.onload=()=>{if(this.imageCache.set(t,O),e&&"OffscreenCanvas"in window)try{const _=new OffscreenCanvas(e,e),N=_.getContext("2d");N.imageSmoothingEnabled=!0,N.imageSmoothingQuality="high",N.drawImage(O,0,0,e,e);const X=_.transferToImageBitmap();this.renderedCache.set(m,X),a(X)}catch{this.imageCache.set(m,O),a(O)}else a(O)},O.onerror=_=>{if(v!==t){console.log(`âš ï¸ WebP no disponible, usando formato original: ${t}`);const N=new Image;/^https?:\/\//i.test(t)&&(N.crossOrigin="anonymous");try{N.decoding="async"}catch{}if("loading"in HTMLImageElement.prototype)try{N.loading="eager"}catch{}N.onload=()=>{this.imageCache.set(t,N),a(N)},N.onerror=()=>{console.warn("âŒ No se pudo cargar imagen:",t),s(new Error(`Failed to load: ${t}`))},N.src=t}else console.warn("âŒ No se pudo cargar imagen:",t),s(_)},O.src=v})}async loadMapImages(t){var m;const e=t.mapImage,a=this.isMobile?e.mobile:e.desktop,s=(a==null?void 0:a.src)||a||((m=e.desktop)==null?void 0:m.src)||e.desktop;if(!s)throw new Error("No se especificÃ³ imagen para el mapa");console.log(`ðŸ–¼ï¸ Cargando imagen ${this.isMobile?"mobile":"desktop"}:`,s);try{const v=await this.loadImage(s);return e.useNaturalSize?(t.mapImage.logicalW=v.naturalWidth,t.mapImage.logicalH=v.naturalHeight):(t.mapImage.logicalW=a.logicalW||e.logicalW||v.naturalWidth,t.mapImage.logicalH=a.logicalH||e.logicalH||v.naturalHeight),console.log(`âœ… Dimensiones lÃ³gicas: ${t.mapImage.logicalW}x${t.mapImage.logicalH}`),console.log(`   Imagen real: ${v.naturalWidth}x${v.naturalHeight}`),{lowRes:v,highRes:v,current:v}}catch(v){throw console.error("âŒ Error cargando imagen del mapa:",v),v}}async preloadIcons(t){const e=new Set;if(Object.values(t.icons||{}).flat().forEach(m=>{m!=null&&m.img&&e.add(m.img)}),!e.size)return;console.log(`ðŸ“¦ Precargando ${e.size} iconos...`);const a=L.ICON_SIZE,s=[...e].map(m=>this.loadImage(m,a).catch(v=>{console.warn(`âš ï¸ Error precargando icono ${m}:`,v)}));await Promise.allSettled(s)}normalizeWaypoints(t,e,a){return t.map(s=>{const m=this.isMobile?s.mobile:s.desktop;return m?{...s,x:(m.xp||.5)*e,y:(m.yp||.5)*a,z:m.z||1,label:s.label,lines:s.lines}:(console.warn("âš ï¸ Waypoint sin configuraciÃ³n mobile/desktop:",s),{...s,x:e/2,y:a/2,z:1})})}normalizeIcons(t,e,a,s){const m={};return Object.entries(t).forEach(([v,O])=>{const _=parseInt(v),N=s[_];if(!N){console.warn("âš ï¸ No se encontrÃ³ waypoint para iconos:",v);return}m[v]=O.map(X=>{const q=this.isMobile?X.mobile:X.desktop;if(!q)return console.warn("âš ï¸ Icono sin configuraciÃ³n mobile/desktop:",X),X;const ae=X.type||"icon",j=q.x!==void 0?q.x:N.x+(q.offsetX||0),n=q.y!==void 0?q.y:N.y+(q.offsetY||0);let fe,se;q.width!==void 0&&q.height!==void 0?(fe=q.width,se=q.height):q.size!==void 0?(fe=q.size,se=q.size):(fe=null,se=null);const be={...X,type:ae,x:j,y:n,width:fe,height:se,rotation:q.rotation||0};return ae==="hotspot"&&(be.radius=q.radius||0,be.debugColor=X.debugColor||"rgba(255, 0, 0, 0.3)"),be})}),m}async loadMap(t){if(!De[t])throw new Error(`âŒ Mapa no encontrado: ${t}`);console.log(`ðŸ—ºï¸ Cargando mapa: ${t} (${this.isMobile?"mobile":"desktop"})`);const e={...De[t]},a=await this.loadMapImages(e);this.preloadIcons(e).catch(_=>console.warn("âš ï¸ Error precargando iconos:",_));const s=e.mapImage.logicalW,m=e.mapImage.logicalH,v=this.normalizeWaypoints(e.waypoints||[],s,m),O=this.normalizeIcons(e.icons||{},s,m,v);return this.currentMapId=t,this.currentMap={config:e,images:a,waypoints:v,icons:O},this.preloadedMaps.add(t),console.log(`âœ… Mapa cargado: ${v.length} waypoints`),this.currentMap}async preloadPhase(t){const e=ye.find(s=>s.id===t);if(!e)return;const a=e.maps.filter(s=>!this.preloadedMaps.has(s)).map(s=>this.loadMap(s).catch(m=>console.warn(`âš ï¸ Error precargando ${s}:`,m)));Promise.allSettled(a)}setPhase(t){if(!ye.find(s=>s.id===t))return!1;this.currentPhase=t;const a=ye.findIndex(s=>s.id===t)+1;return a<ye.length&&this.preloadPhase(ye[a].id),!0}getCurrentPhaseMaps(){const t=ye.find(e=>e.id===this.currentPhase);return t?t.maps.map(e=>({id:e,name:De[e].name})):[]}getImage(t,e=!1){if(!t)return null;if(e){const a=L.ICON_SIZE,s=`${t}_${a}`;if(this.renderedCache.has(s))return this.renderedCache.get(s)}return this.imageCache.get(t)}getCurrentPhaseColor(){const t=ye.find(e=>e.id===this.currentPhase);return(t==null?void 0:t.color)||"#1BC6EB"}getCurrentPhaseColorRgb(){const e=this.getCurrentPhaseColor().replace("#",""),a=parseInt(e.substring(0,2),16),s=parseInt(e.substring(2,4),16),m=parseInt(e.substring(4,6),16);return`${a}, ${s}, ${m}`}async reloadCurrentMap(){return this.currentMapId?(console.log("ðŸ”„ Recargando mapa por cambio de viewport..."),this.renderedCache.clear(),await this.loadMap(this.currentMapId)):null}clearOldMaps(t=[this.currentPhase]){const e=new Set;ye.filter(s=>t.includes(s.id)).forEach(s=>s.maps.forEach(m=>e.add(m)));let a=0;for(const s of this.preloadedMaps)e.has(s)||(this.preloadedMaps.delete(s),a++);a>0&&console.log(`ðŸ§¹ Limpiados ${a} mapas de la memoria`)}getCacheStats(){return{images:this.imageCache.size,rendered:this.renderedCache.size,maps:this.preloadedMaps.size,supportsWebP:this.supportsWebP,totalMemoryEstimate:`~${Math.round((this.imageCache.size+this.renderedCache.size)*.5)}MB`}}logPerformanceStats(){const t=this.getCacheStats();console.log("ðŸ“Š EstadÃ­sticas de MapManager:"),console.table(t)}}class st{constructor(t,e,a){this.mapManager=t,this.onPhaseChange=e,this.onMapChange=a,this.phaseFilter=document.getElementById("phase-filter"),this.mapSelector=document.getElementById("map-selector"),this.drawer=document.getElementById("menu-puntos"),this.drawerList=document.getElementById("drawer-list"),this.progressEl=document.querySelector(".progress"),this.init()}init(){this.renderPhaseFilter(),this.updateMapSelector()}renderPhaseFilter(){this.phaseFilter.innerHTML=ye.map(t=>`
      <button 
        class="phase-btn ${t.id===this.mapManager.currentPhase?"active":""}" 
        data-phase="${t.id}"
        style="--phase-color: ${t.color}"
      >
        <span>${t.label}</span>
      </button>
    `).join(""),this.phaseFilter.querySelectorAll(".phase-btn").forEach(t=>{t.addEventListener("click",()=>{const e=t.dataset.phase;this.selectPhase(e)})})}async selectPhase(t){if(!this.mapManager.setPhase(t))return;this.phaseFilter.querySelectorAll(".phase-btn").forEach(a=>{a.classList.toggle("active",a.dataset.phase===t)}),this.updateMapSelector();const e=this.mapManager.getCurrentPhaseMaps();e.length>0&&await this.onPhaseChange(t,e[0].id)}updateMapSelector(){const t=this.mapManager.getCurrentPhaseMaps();this.mapSelector.innerHTML=t.length>1?`
      <label for="map-select" class="sr-only">Seleccionar mapa</label>
      <select id="map-select" class="map-select">
        ${t.map((a,s)=>`
          <option value="${a.id}" ${s===0?"selected":""}>
            ${a.name}
          </option>
        `).join("")}
      </select>
    `:"";const e=document.getElementById("map-select");e&&e.addEventListener("change",a=>{this.onMapChange(a.target.value)})}updateProgress(t,e){this.progressEl.innerHTML=Array(t).fill(0).map((a,s)=>`<span class="${s===e?"active":""}"></span>`).join(""),this.progressEl.querySelectorAll("span").forEach((a,s)=>{a.style.cursor="pointer",a.addEventListener("click",()=>{document.dispatchEvent(new CustomEvent("goto-waypoint",{detail:s}))})})}updateDrawer(t){this.drawerList.innerHTML=t.map((e,a)=>`
      <li>
        <button type="button" data-index="${a}">
          <span>${a+1}. ${e.label||"Punto "+(a+1)}</span>
          <small>${e.speaker||""}</small>
        </button>
      </li>
    `).join(""),this.drawerList.querySelectorAll("button").forEach(e=>{e.addEventListener("click",()=>{const a=parseInt(e.dataset.index);document.dispatchEvent(new CustomEvent("goto-waypoint",{detail:a})),this.closeDrawer()})})}openDrawer(){this.drawer.classList.add("drawer--open"),this.drawer.setAttribute("aria-hidden","false"),document.querySelector(".hamburger").setAttribute("aria-expanded","true"),document.querySelector(".drawer-backdrop").hidden=!1}closeDrawer(){this.drawer.classList.remove("drawer--open"),this.drawer.setAttribute("aria-hidden","true"),document.querySelector(".hamburger").setAttribute("aria-expanded","false"),document.querySelector(".drawer-backdrop").hidden=!0}setLoading(t){const e=document.getElementById("loading-spinner");e&&(e.hidden=!t)}updateThemeColor(t,e){document.documentElement.style.setProperty("--phase-color",t),document.documentElement.style.setProperty("--phase-color-rgb",e)}}class rt{constructor(){this.popupSimple=document.getElementById("popup"),this.popupSimpleTitle=document.getElementById("popup-title"),this.popupSimpleBody=document.getElementById("popup-body"),this.popupSimpleClose=document.getElementById("popup-close"),this.popupDetailed=document.getElementById("popup-detailed"),this.popupDetailedClose=document.getElementById("popup-detailed-close"),this.popupDetailedImage=document.getElementById("popup-detailed-image"),this.popupDetailedTitle=document.getElementById("popup-detailed-title"),this.popupDetailedDate=document.getElementById("popup-detailed-date"),this.popupDetailedTime=document.getElementById("popup-detailed-time"),this.popupDetailedLocation=document.getElementById("popup-detailed-location"),this.popupDetailedDescription=document.getElementById("popup-detailed-description"),this.popupDetailedInvolved=document.getElementById("popup-detailed-involved"),this.popupDetailedInvolvedSection=document.getElementById("popup-detailed-involved-section"),this.popupDetailedEchos=document.getElementById("popup-detailed-echos"),this.popupDetailedEchosSection=document.getElementById("popup-detailed-echos-section"),this.popupDetailedEchosTitle=document.getElementById("popup-detailed-echos-title"),this.backdrop=document.getElementById("popup-backdrop"),this.currentHotspot=null,this.selectedPersonId=null,this.initEventListeners()}initEventListeners(){var t,e,a;(t=this.popupSimpleClose)==null||t.addEventListener("click",()=>this.closeAll()),(e=this.popupDetailedClose)==null||e.addEventListener("click",()=>this.closeAll()),(a=this.backdrop)==null||a.addEventListener("click",()=>this.closeAll()),document.addEventListener("keydown",s=>{s.key==="Escape"&&(!this.popupSimple.hidden||!this.popupDetailed.hidden)&&this.closeAll()})}isDetailedHotspot(t){return!!(t.datetime||t.location||t.description||t.involved||t.echos||t.image)}openPopup(t){this.isDetailedHotspot(t)?this.openDetailedPopup(t):this.openSimplePopup(t)}openSimplePopup(t){this.closeAll(),this.popupSimpleTitle.textContent=t.title||"",this.popupSimpleBody.textContent=t.body||"",this.popupSimple.hidden=!1,this.backdrop.hidden=!1}openDetailedPopup(t){if(this.closeAll(),this.currentHotspot=t,this.popupDetailedTitle.textContent=t.title||"",t.image?(this.popupDetailedImage.src=t.image,this.popupDetailedImage.alt=t.title||"",this.popupDetailedImage.parentElement.style.display="block"):this.popupDetailedImage.parentElement.style.display="none",t.datetime&&(this.popupDetailedDate.textContent=t.datetime.date||"",this.popupDetailedTime.textContent=t.datetime.time||"",t.datetime.timeColor&&(this.popupDetailedTime.style.color=t.datetime.timeColor)),t.location?(this.popupDetailedLocation.textContent=t.location,this.popupDetailedLocation.style.display="block"):this.popupDetailedLocation.style.display="none",t.description?(this.popupDetailedDescription.textContent=t.description,this.popupDetailedDescription.style.display="block"):this.popupDetailedDescription.style.display="none",t.involved&&t.involved.length>0){this.renderInvolved(t.involved),this.popupDetailedInvolvedSection.hidden=!1;const e=t.involved.find(s=>s.highlighted),a=t.involved[0];this.selectedPersonId=e?e.id:a.id,this.updateEchos()}else this.popupDetailedInvolvedSection.hidden=!0,this.popupDetailedEchosSection.hidden=!0;this.popupDetailed.hidden=!1,this.backdrop.hidden=!1}renderInvolved(t){this.popupDetailedInvolved.innerHTML="",t.forEach(e=>{const a=document.createElement("div");a.className="popup-detailed__person",a.dataset.personId=e.id,(e.id===this.selectedPersonId||e.highlighted)&&a.classList.add("active"),a.innerHTML=`
        <div class="popup-detailed__person-avatar-wrapper">
          <img 
            src="${e.avatar||"./assets/default.jpg"}" 
            alt="${e.name}"
            class="popup-detailed__person-avatar"
          />
        </div>
        <div class="popup-detailed__person-name">${e.name}</div>
        ${e.role?`<div class="popup-detailed__person-role">${e.role}</div>`:""}
      `,a.addEventListener("click",()=>{this.selectPerson(e.id)}),this.popupDetailedInvolved.appendChild(a)})}selectPerson(t){this.selectedPersonId=t,this.popupDetailedInvolved.querySelectorAll(".popup-detailed__person").forEach(e=>{e.classList.toggle("active",e.dataset.personId===t)}),this.updateEchos()}updateEchos(){var a;if(!this.currentHotspot||!this.currentHotspot.echos||!this.selectedPersonId){this.popupDetailedEchosSection.hidden=!0;return}const t=this.currentHotspot.echos[this.selectedPersonId];if(!t||t.length===0){this.popupDetailedEchosSection.hidden=!0;return}const e=(a=this.currentHotspot.involved)==null?void 0:a.find(s=>s.id===this.selectedPersonId);e?this.popupDetailedEchosTitle.textContent=`Echos de ${e.name}:`:this.popupDetailedEchosTitle.textContent="Echos:",this.popupDetailedEchos.innerHTML="",t.forEach(s=>{var v,O;const m=document.createElement("div");m.className="popup-detailed__echo",m.innerHTML=`
        <div class="popup-detailed__echo-datetime">
          <span class="popup-detailed__echo-date">${((v=s.datetime)==null?void 0:v.date)||""}</span>
          <span class="popup-detailed__echo-time">${((O=s.datetime)==null?void 0:O.time)||""}</span>
        </div>
        <div class="popup-detailed__echo-description">${s.description||""}</div>
      `,this.popupDetailedEchos.appendChild(m)}),this.popupDetailedEchosSection.hidden=!1}closeAll(){this.popupSimple.hidden=!0,this.popupDetailed.hidden=!0,this.backdrop.hidden=!0,this.currentHotspot=null,this.selectedPersonId=null,this.popupDetailedTime.style.color=""}isOpen(){return!this.popupSimple.hidden||!this.popupDetailed.hidden}}function dt(){const y=new URLSearchParams(location.search),t={};if(y.has("scale")){const e=Number(y.get("scale"));Number.isNaN(e)||(t.scale=Math.min(110,Math.max(80,e))/100)}return y.has("debug")&&(t.debug=y.get("debug")==="1"),y.has("editor")&&(window.__EDITOR_ACTIVE__=y.get("editor")==="1"),t}const $e=dt(),tt={info:(...y)=>$e.debug&&console.info("[info]",...y),warn:(...y)=>console.warn("[warn]",...y),error:(...y)=>console.error("[error]",...y)};function Oe(){const y=document.getElementById("mapa-canvas-wrapper");if(!y)return;const t=$e.scale||1,e=Math.floor(window.innerWidth*t),a=Math.floor(window.innerHeight*t);y.style.width=e+"px",y.style.height=a+"px",document.body.style.background="#000";const s=t>1;document.documentElement.style.overflow=s?"hidden":"",document.body.style.overflow=s?"hidden":"",tt.info("Viewport coverage â†’",Math.round(t*100)+"%",{vw:e,vh:a})}window.LayoutFill=window.LayoutFill||{set(y=100){const t=Math.min(110,Math.max(80,Number(y)))/100;$e.scale=t,Oe();try{window.requestAnimationFrame(()=>{var e,a;(e=window.setCanvasDPR)==null||e.call(window),(a=window.markDirty)==null||a.call(window,"camera","elements","dialog","minimap","debug")})}catch{}}};class Qe{constructor(t,e=500){this.waypoints=t,this.cellSize=e,this.grid=new Map,this.bounds={minX:1/0,maxX:-1/0,minY:1/0,maxY:-1/0},this.build()}build(){this.waypoints.forEach((t,e)=>{const a=Math.floor(t.x/this.cellSize),s=Math.floor(t.y/this.cellSize),m=`${a},${s}`;this.grid.has(m)||this.grid.set(m,[]),this.grid.get(m).push({...t,originalIndex:e}),this.bounds.minX=Math.min(this.bounds.minX,t.x),this.bounds.maxX=Math.max(this.bounds.maxX,t.x),this.bounds.minY=Math.min(this.bounds.minY,t.y),this.bounds.maxY=Math.max(this.bounds.maxY,t.y)})}query(t){const e=Math.floor(t.left/this.cellSize),a=Math.ceil(t.right/this.cellSize),s=Math.floor(t.top/this.cellSize),m=Math.ceil(t.bottom/this.cellSize),v=[],O=new Set;for(let _=e;_<=a;_++)for(let N=s;N<=m;N++){const X=`${_},${N}`,q=this.grid.get(X);q&&q.forEach(ae=>{O.has(ae.originalIndex)||(O.add(ae.originalIndex),v.push(ae))})}return v}}class lt{constructor(){this.samples=[],this.maxSamples=60,this.lastSample=0,this.sampleInterval=1e3}sample(){if(!performance.memory)return null;const t=performance.now();if(t-this.lastSample<this.sampleInterval)return null;this.lastSample=t;const e={timestamp:t,usedJSHeapSize:performance.memory.usedJSHeapSize,totalJSHeapSize:performance.memory.totalJSHeapSize,jsHeapSizeLimit:performance.memory.jsHeapSizeLimit,usedMB:performance.memory.usedJSHeapSize/(1024*1024),percentUsed:performance.memory.usedJSHeapSize/performance.memory.jsHeapSizeLimit*100};return this.samples.push(e),this.samples.length>this.maxSamples&&this.samples.shift(),e}getStats(){if(this.samples.length===0)return null;const t=this.samples[this.samples.length-1],e=this.samples.reduce((s,m)=>s+m.usedMB,0)/this.samples.length,a=Math.max(...this.samples.map(s=>s.usedMB));return{current:t.usedMB.toFixed(2)+"MB",average:e.toFixed(2)+"MB",peak:a.toFixed(2)+"MB",percentUsed:t.percentUsed.toFixed(1)+"%",limit:(t.jsHeapSizeLimit/(1024*1024)).toFixed(2)+"MB"}}isMemoryPressure(){if(!performance.memory)return!1;const t=this.samples[this.samples.length-1];return t&&t.percentUsed>85}}function et(y,t,e){const a=e?L.CANVAS_LIMITS.mobile:L.CANVAS_LIMITS.desktop;let s=!1,m=[];y>a.maxWidth&&(m.push(`Width ${y}px excede lÃ­mite ${a.maxWidth}px`),y=a.maxWidth,s=!0),t>a.maxHeight&&(m.push(`Height ${t}px excede lÃ­mite ${a.maxHeight}px`),t=a.maxHeight,s=!0);const v=y*t;if(v>a.maxPixels){m.push(`Total pixels ${v.toLocaleString()} excede lÃ­mite ${a.maxPixels.toLocaleString()}`);const _=Math.sqrt(a.maxPixels/v);y=Math.floor(y*_),t=Math.floor(t*_),s=!0}const O=y*t*4/(1024*1024);if(O>a.maxMemoryMB){m.push(`Memoria estimada ${O.toFixed(2)}MB excede lÃ­mite ${a.maxMemoryMB}MB`);const _=Math.sqrt(a.maxMemoryMB/O);y=Math.floor(y*_),t=Math.floor(t*_),s=!0}return m.length>0&&(console.warn("âš ï¸ Canvas dimensions adjusted:"),m.forEach(_=>console.warn("   - "+_)),console.warn(`   Final: ${y}Ã—${t} (${v.toLocaleString()} px, ~${O.toFixed(2)}MB)`)),{width:y,height:t,adjusted:s,warnings:m,estimatedMemoryMB:O}}let Te=null,We=new lt;(()=>{let{BASE_W:y,BASE_H:t}=L;const{TYPE_SPEED:e,EASE:a,MARKER_R:s,ICON_R:m,ICON_SIZE:v,DIALOG_BOX:O,DPR_MAX:_,CANVAS_MIN_HEIGHT:N}=L,X=Object.freeze({TWO_PI:Math.PI*2,ACTIVE_MARKER_FILL:"rgba(255,255,255,0.95)",INACTIVE_MARKER_FILL:"rgba(255,255,255,0.6)",MARKER_STROKE_COLOR:"rgba(0,0,0,0.55)",MARKER_STROKE_WIDTH:2,BLACK_BG:"#000",ZOOM_SQRT_CACHE:new Map});function q(i){const r=i.toFixed(4);return X.ZOOM_SQRT_CACHE.has(r)||X.ZOOM_SQRT_CACHE.set(r,Math.sqrt(i)),X.ZOOM_SQRT_CACHE.get(r)}document.body.classList.add("debug-minimap-mobile");const ae=document.getElementById("mapa-canvas-wrapper"),j=document.getElementById("mapa-canvas"),n=j.getContext("2d",{alpha:!1}),fe=document.getElementById("minimap"),se=fe.getContext("2d"),be=ae.querySelector(".sr-live");document.querySelector(".ui");const Y=new at;window.mapManager=Y;let re,we;const l={idx:0,lineIndex:0,typedText:"",typing:!1,lastTick:0,currentWaypoints:[],currentIcons:{},mapImages:null,isFirstLoad:!0},u={x:0,y:0,z:1},Z={x:0,y:0,z:1},de={camera:!1,elements:!1,dialog:!1,minimap:!1,debug:!1,cameraMoving:!1};function te(...i){i.forEach(r=>{de.hasOwnProperty(r)&&(de[r]=!0)})}function Xe(){Object.keys(de).forEach(i=>de[i]=!1)}function Ne(){return de.camera||de.elements||de.dialog||de.minimap||de.debug||de.cameraMoving||l.typing||B.active||L.CAMERA_EFFECTS.breathingEnabled}const B={active:!1,startTime:0,duration:L.CAMERA_EFFECTS.transitionDuration,startZ:1,targetZ:1,peakZOffset:L.CAMERA_EFFECTS.transitionZoomOut,startPos:{x:0,y:0},targetPos:{x:0,y:0}},$={left:0,right:0,top:0,bottom:0};function He(i,r,h=200){const p=i/2/u.z,f=r/2/u.z;$.left=u.x-p-h,$.right=u.x+p+h,$.top=u.y-f-h,$.bottom=u.y+f+h}function _e(i,r){const h=(W,J)=>Number.isFinite(W)&&W>0?W:J,p=h(i.width,v),f=h(i.height,v),c=p/r,C=f/r,k=c*.5,z=C*.5;return!(i.x+k<$.left||i.x-k>$.right||i.y+z<$.top||i.y-z>$.bottom)}function qe(i,r){if(!i||i.length===0)return[];if(window.__EDITOR_ACTIVE__)return i;const h=[];for(let p=0;p<i.length;p++)_e(i[p],r)&&h.push(i[p]);return h}window.addEventListener("editor:getMapCoords",i=>{const{clientX:r,clientY:h}=i.detail,p=ve(r,h);window.dispatchEvent(new CustomEvent("editor:mapCoordsResponse",{detail:{x:p.x,y:p.y,items:l.currentIcons[l.idx]||[],waypoint:l.currentWaypoints[l.idx],waypointIndex:l.idx,camera:u,ICON_SIZE:v}}))}),addEventListener("editor:getWaypointData",i=>{const r=i.detail.waypointIndex,h=l.currentWaypoints,p=l.currentIcons,f=h[r],c=p[r]||[],C={x:u.x,y:u.y,z:u.z};window.dispatchEvent(new CustomEvent("editor:waypointDataResponse",{detail:{waypoint:f,items:c,camera:C}}))}),addEventListener("editor:updateWaypoint",i=>{const{waypointIndex:r,device:h,values:p}=i.detail,f=Y.currentMapId,c=De[f];if(!c||!c.waypoints||!c.waypoints[r])return;c.waypoints[r][h]||(c.waypoints[r][h]={}),Object.assign(c.waypoints[r][h],p);const C=c.mapImage.logicalW,k=c.mapImage.logicalH,z=Y.normalizeWaypoints(c.waypoints,C,k);Y.currentMap.waypoints=z,l.currentWaypoints=z,Te&&L.WAYPOINT_RENDERING.useSpatialIndex&&(Te=new Qe(l.currentWaypoints,L.WAYPOINT_RENDERING.cellSize)),te("camera","elements","minimap")}),addEventListener("editor:getWaypointCode",i=>{const{waypointIndex:r,device:h}=i.detail,p=Y.currentMapId,c=De[p].waypoints[r][h];if(!c)return;const C=`{ ${h}: { xp: ${c.xp}, yp: ${c.yp}, z: ${c.z} } }`;window.dispatchEvent(new CustomEvent("editor:itemCodeResponse",{detail:{code:C}}))}),window.addEventListener("editor:getItemCode",i=>{var c;const{waypointIndex:r,itemIndex:h}=i.detail,p=(c=l.currentIcons[r])==null?void 0:c[h],f=l.currentWaypoints[r];if(p&&f){const C=Math.round(p.x-f.x),k=Math.round(p.y-f.y),z=`{
  type: '${p.type||"hotspot"}',${p.img?`
  img: '${p.img}',`:""}
  mobile: { offsetX: ${C}, offsetY: ${k}, width: ${Math.round(p.width)}, height: ${Math.round(p.height)}, rotation: ${p.rotation||0} },
  desktop: { offsetX: ${C}, offsetY: ${k}, width: ${Math.round(p.width)}, height: ${Math.round(p.height)}, rotation: ${p.rotation||0} },
  title: '${p.title||"TÃ­tulo"}',
  body: '${p.body||"DescripciÃ³n..."}'
}`;window.dispatchEvent(new CustomEvent("editor:itemCodeResponse",{detail:{code:z,item:p,offsetX:C,offsetY:k}}))}}),window.addEventListener("editor:itemSelected",()=>{te("debug")}),window.addEventListener("editor:itemDeselected",()=>{te("debug")}),window.addEventListener("editor:redraw",()=>{te("camera","elements","debug")});let U={frameCount:0,lastFpsUpdate:0,fps:60,skippedFrames:0,culledItems:0,totalItems:0,visibleWaypoints:0,culledWaypoints:0};function Ae(i){if(U.frameCount++,We.sample(),i-U.lastFpsUpdate>=1e3){U.fps=Math.round(U.frameCount*1e3/(i-U.lastFpsUpdate));{const r=We.getStats();console.log(`
ðŸ“Š Performance Stats:
â”œâ”€ FPS: ${U.fps}
â”œâ”€ Waypoints: ${U.visibleWaypoints}/${U.visibleWaypoints+U.culledWaypoints} visible
â”œâ”€ Icons: ${U.totalItems-U.culledItems}/${U.totalItems} visible
â”œâ”€ Skipped frames: ${U.skippedFrames}
${r?`â”œâ”€ Memory: ${r.current} (avg: ${r.average}, peak: ${r.peak})
â””â”€ Memory usage: ${r.percentUsed} of ${r.limit}`:""}
        `),We.isMemoryPressure()&&(console.warn("âš ï¸ HIGH MEMORY PRESSURE DETECTED"),console.log("ðŸ§¹ Liberando memoria automÃ¡ticamente..."),Y.clearOldMaps())}U.frameCount=0,U.lastFpsUpdate=i,U.skippedFrames=0}}async function Se(i){re.setLoading(!0);try{if(L.MEMORY_MANAGEMENT.logMemoryUsage){const f=We.sample();f&&console.log("ðŸ’¾ Memoria antes:",f.usedMB.toFixed(2)+"MB")}const r=await Y.loadMap(i);l.currentWaypoints=r.waypoints,l.currentIcons=r.icons||{},l.mapImages=r.images,L.WAYPOINT_RENDERING.useSpatialIndex&&l.currentWaypoints.length>=L.WAYPOINT_RENDERING.spatialIndexThreshold?(Te=new Qe(l.currentWaypoints,L.WAYPOINT_RENDERING.cellSize),console.log(`ðŸ—‚ï¸ Spatial index creado para ${l.currentWaypoints.length} waypoints`)):Te=null,re.updateProgress(l.currentWaypoints.length,0),re.updateDrawer(l.currentWaypoints);const h=Y.getCurrentPhaseColor(),p=Y.getCurrentPhaseColorRgb();re.updateThemeColor(h,p),ze(),d(0),te("camera","elements","dialog","minimap"),L.MEMORY_MANAGEMENT.logMemoryUsage&&setTimeout(()=>{const f=We.sample();f&&console.log("ðŸ’¾ Memoria despuÃ©s:",f.usedMB.toFixed(2)+"MB")},100)}catch(r){console.error("Error cargando mapa:",r)}finally{re.setLoading(!1)}}async function Ye(i,r){await Se(r),re.updateMapSelector()}async function o(i){await Se(i)}function d(i){if(!l.currentWaypoints.length)return;l.idx=i,l.lineIndex=0;const r=l.currentWaypoints[i],h=window.matchMedia("(max-width: 899px)").matches,p=!!(L&&L.WAYPOINT_OFFSET),f=h?p?L.WAYPOINT_OFFSET.mobile:0:p?L.WAYPOINT_OFFSET.desktop:0,C=(r.yOffset!==null&&r.yOffset!==void 0?r.yOffset:f)/(r.z||1.6),k=r.x,z=r.y+C,W=E(r.z||1.6,.6,3);l.isFirstLoad?(u.x=k,u.y=z,u.z=W,Z.x=k,Z.y=z,Z.z=W,l.isFirstLoad=!1):(B.active=!0,B.startTime=performance.now(),B.startZ=u.z,B.targetZ=W,B.startPos={x:u.x,y:u.y},B.targetPos={x:k,y:z}),Z.x=k,Z.y=z,Z.z=W,S(),re.updateProgress(l.currentWaypoints.length,i),te("camera","elements","dialog","minimap")}function E(i,r,h){return Math.max(r,Math.min(h,i))}function w(i,r,h){return i+(r-i)*h}function g(i,r=L.CAMERA_EFFECTS.transitionEasing){switch(r){case"linear":return i;case"ease-in":return i*i;case"ease-out":return i*(2-i);case"ease-in-out":default:return i<.5?2*i*i:1-Math.pow(-2*i+2,2)/2}}function x(i){if(!B.active)return;const r=i-B.startTime,h=Math.min(r/B.duration,1),p=g(h),f=Math.sin(p*Math.PI),c=B.startZ-B.startZ*B.peakZOffset*f,C=B.startPos.x+(B.targetPos.x-B.startPos.x)*p,k=B.startPos.y+(B.targetPos.y-B.startPos.y)*p;if(Z.x=C,Z.y=k,Z.z=E(c,.4,3),h>=1){B.active=!1;const z=l.currentWaypoints[l.idx];if(z){const W=window.matchMedia("(max-width: 899px)").matches,J=!!(L&&L.WAYPOINT_OFFSET),oe=W?J?L.WAYPOINT_OFFSET.mobile:0:J?L.WAYPOINT_OFFSET.desktop:0,R=(z.yOffset!==null&&z.yOffset!==void 0?z.yOffset:oe)/(z.z||1.6);Z.x=z.x,Z.y=z.y+R,Z.z=B.targetZ}}te("camera","elements","minimap")}function D(){var W,J,oe,ee,R;if(!l.mapImages||!Y.currentMap)return;const i=Math.min(_,window.devicePixelRatio||1),r=j.width/i,h=j.height/i,p=q(u.z);He(r,h,window.__EDITOR_ACTIVE__?600:200),n.save(),n.translate(r/2,h/2),n.scale(u.z,u.z),n.translate(-u.x,-u.y),n.fillStyle=X.BLACK_BG;const f=100;n.fillRect(u.x-r/(2*u.z)-f,u.y-h/(2*u.z)-f,r/u.z+f*2,h/u.z+f*2);const c=l.mapImages.highRes||l.mapImages.lowRes;c&&(n.imageSmoothingEnabled=!0,n.drawImage(c,0,0,c.naturalWidth,c.naturalHeight));let C;Te?C=Te.query($):C=l.currentWaypoints.filter(P=>!(P.x+s<$.left||P.x-s>$.right||P.y+s<$.top||P.y-s>$.bottom)).map((P,b)=>({...P,originalIndex:b})),C.length>L.WAYPOINT_RENDERING.maxVisibleWaypoints&&(C.sort((P,b)=>Math.hypot(P.x-u.x,P.y-u.y)-Math.hypot(b.x-u.x,b.y-u.y)),C=C.slice(0,L.WAYPOINT_RENDERING.maxVisibleWaypoints)),C.forEach(P=>{const b=P.originalIndex!==void 0?P.originalIndex:l.currentWaypoints.indexOf(P);n.beginPath(),n.arc(P.x,P.y,s,0,X.TWO_PI),n.fillStyle=b===l.idx?X.ACTIVE_MARKER_FILL:X.INACTIVE_MARKER_FILL,n.fill(),n.lineWidth=X.MARKER_STROKE_WIDTH,n.strokeStyle=X.MARKER_STROKE_COLOR,n.stroke()}),U.visibleWaypoints=C.length,U.culledWaypoints=l.currentWaypoints.length-C.length;const k=l.currentIcons[l.idx]||[],z=qe(k,p);U.totalItems=k.length,U.culledItems=k.length-z.length;for(let P=0;P<z.length;P++){const b=z[P],ie=b.type||"icon",he=Number.isFinite(b.width)?b.width:v,Ie=Number.isFinite(b.height)?b.height:v,ne=Math.max(1,he),pe=Math.max(1,Ie);let G,H;if(Y.isMobile&&((J=(W=L.RESPONSIVE_SIZING)==null?void 0:W.mobile)==null?void 0:J.lockItemWidthToScreenPx)||b.lockScreenSize&&b.lockScreenSize.widthPx)if(G=(((oe=b.lockScreenSize)==null?void 0:oe.widthPx)??ne)/u.z,(ee=b.lockScreenSize)!=null&&ee.keepAspect&&b.img){const Q=Y.getImage(b.img);if(Q&&Q.naturalWidth&&Q.naturalHeight){const ce=Q.naturalWidth/Q.naturalHeight;H=G/ce}else H=pe/ne*G}else H=(((R=b.lockScreenSize)==null?void 0:R.heightPx)??pe)/u.z;else G=ne/p,H=pe/p;const Pe=G*.5,Me=H*.5;if(n.save(),b.rotation&&(n.translate(b.x,b.y),n.rotate(b.rotation*Math.PI/180),n.translate(-b.x,-b.y)),ie==="icon"){const le=Y.getImage(b.img);n.beginPath(),n.arc(b.x,b.y,m,0,X.TWO_PI),n.fillStyle=L.ICON_STYLES.backgroundColor,n.fill(),le&&n.drawImage(le,b.x-Pe,b.y-Me,G,H),n.beginPath(),n.arc(b.x,b.y,m,0,X.TWO_PI),n.strokeStyle=L.ICON_STYLES.borderColor,n.lineWidth=L.ICON_STYLES.borderWidth,n.stroke()}else if(ie==="hotspot"){const le=(b.radius||0)/p;n.fillStyle=b.debugColor||"rgba(255, 0, 0, 0.3)",n.strokeStyle="rgba(255, 0, 0, 0.8)",n.lineWidth=2/p,n.beginPath();const Q=b.x-Pe,ce=b.y-Me;n.moveTo(Q+le,ce),n.arcTo(Q+G,ce,Q+G,ce+H,le),n.arcTo(Q+G,ce+H,Q,ce+H,le),n.arcTo(Q,ce+H,Q,ce,le),n.arcTo(Q,ce,Q+G,ce,le),n.closePath(),n.fill(),n.stroke(),n.fillStyle="rgba(255, 255, 255, 0.9)",n.font=`${12/p}px monospace`,n.textAlign="center",n.fillText("HOTSPOT",b.x,b.y)}else if(ie==="image"){const le=Y.getImage(b.img);le&&(n.drawImage(le,b.x-Pe,b.y-Me,G,H),n.strokeStyle="rgba(0, 255, 0, 0.8)",n.lineWidth=2/p,n.strokeRect(b.x-Pe,b.y-Me,G,H))}n.restore()}n.restore()}function M(){var C,k,z,W,J,oe,ee;const i=Math.min(_,window.devicePixelRatio||1),r=j.width/i,h=j.height/i;n.save(),n.translate(r/2,h/2),n.scale(u.z,u.z),n.translate(-u.x,-u.y);const p=((C=Y.currentMap)==null?void 0:C.config.mapImage.logicalW)||2858,f=((k=Y.currentMap)==null?void 0:k.config.mapImage.logicalH)||2858,c=q(u.z);{n.strokeStyle="rgba(255, 255, 255, 0.15)",n.lineWidth=1/u.z,n.setLineDash([5/u.z,5/u.z]);for(let R=0;R<=10;R++){const P=p/10*R;n.beginPath(),n.moveTo(P,0),n.lineTo(P,f),n.stroke()}for(let R=0;R<=10;R++){const P=f/10*R;n.beginPath(),n.moveTo(0,P),n.lineTo(p,P),n.stroke()}n.setLineDash([])}if(l.currentWaypoints.length>0){const R=l.currentIcons[l.idx]||[],P=l.currentWaypoints[l.idx];if(P)for(let b=0;b<R.length;b++){const ie=R[b],he=Math.round(ie.x-P.x),Ie=Math.round(ie.y-P.y),ne=`#${b}: (${he}, ${Ie})`;n.font=`${14/c}px monospace`,n.textAlign="center";const G=n.measureText(ne).width,H=16/c;n.fillStyle="rgba(0, 0, 0, 0.8)",n.fillRect(ie.x-G/2-4,ie.y-H-8,G+8,H+4),n.fillStyle="#FFD700",n.fillText(ne,ie.x,ie.y-8)}}for(let R=0;R<l.currentWaypoints.length;R++){const P=l.currentWaypoints[R];n.font=`bold ${16/c}px sans-serif`,n.textAlign="center",n.textBaseline="middle",n.fillStyle=R===l.idx?"#000":"#fff",n.fillText(R,P.x,P.y);const b=`(${Math.round(P.x)}, ${Math.round(P.y)})`;n.font=`${12/c}px monospace`,n.fillStyle="#1BC6EB",n.fillText(b,P.x,P.y+20/c)}if(l.currentWaypoints&&l.currentWaypoints.length){const R=Y.isMobile?"mobile":"desktop",P=Y.currentMapId,b=De[P],ie=10/c,he=10/c,Ie=18/c,ne=260/c,pe=86/c;n.textAlign="left",n.textBaseline="top",n.font=`${14/c}px monospace`;for(let G=0;G<l.currentWaypoints.length;G++){const H=l.currentWaypoints[G],Ge=(J=(W=(z=b==null?void 0:b.waypoints)==null?void 0:z[G])==null?void 0:W[R])==null?void 0:J.z,Pe=Ge!==void 0?Ge:H.z??1,Me=((oe=Y.currentMap)==null?void 0:oe.config.mapImage.logicalW)||2858,le=((ee=Y.currentMap)==null?void 0:ee.config.mapImage.logicalH)||2858,Q=H.x/Me,ce=H.y/le;let me=H.x+16/c,ue=H.y-(pe+16/c);me+ne>Me&&(me=Me-ne-8/c),ue<0&&(ue=H.y+16/c),n.beginPath(),n.moveTo(me+he,ue),n.arcTo(me+ne,ue,me+ne,ue+pe,he),n.arcTo(me+ne,ue+pe,me,ue+pe,he),n.arcTo(me,ue+pe,me,ue,he),n.arcTo(me,ue,me+ne,ue,he),n.closePath(),n.fillStyle="rgba(0,0,0,0.75)",n.strokeStyle="rgba(255,255,255,0.2)",n.lineWidth=1/c,n.fill(),n.stroke();let Ve=me+ie,Le=ue+ie;n.fillStyle="#B7FBFF",n.font=`bold ${14/c}px monospace`,n.fillText(`ðŸ“ Waypoint #${G} (${R})`,Ve,Le),n.font=`${14/c}px monospace`,n.fillStyle="#9FF1FF",Le+=Ie,n.fillText(`abs: x:${Math.round(H.x)} y:${Math.round(H.y)} z:${Pe}`,Ve,Le),Le+=Ie,n.fillText(`norm: xp:${Q.toFixed(4)} yp:${ce.toFixed(4)}`,Ve,Le)}}n.restore()}function I(){if(!l.mapImages||!Y.currentMap)return;const i=Y.currentMap.config.mapImage,r=fe.width,h=fe.height;se.clearRect(0,0,r,h);const p=l.mapImages.highRes||l.mapImages.lowRes;if(!p)return;const f=p.naturalWidth/p.naturalHeight,c=r/h;let C,k,z,W;f>c?(C=r,k=C/f,z=0,W=(h-k)/2):(k=h,C=k*f,W=0,z=(r-C)/2),se.drawImage(p,z,W,C,k);const J=Math.min(_,window.devicePixelRatio||1),oe=j.width/J,ee=j.height/J,R=C/i.logicalW,P=k/i.logicalH,b=oe/u.z,ie=ee/u.z,he=u.x-b/2,Ie=u.y-ie/2,ne=z+he*R,pe=W+Ie*P,G=b*R,H=ie*P;se.strokeStyle="#00d1ff",se.lineWidth=2,se.strokeRect(ne,pe,G,H)}function T(){const i=Math.min(_,window.devicePixelRatio||1),r=j.width/i,h=j.height/i;n.fillStyle=X.BLACK_BG,n.fillRect(0,0,r,h),D(),M(),I(),window.__EDITOR_ACTIVE__&&window.dispatchEvent(new CustomEvent("editor:redraw"))}function F(i){if(!l.currentWaypoints.length||!l.typing)return;const r=l.currentWaypoints[l.idx],h=r.lines&&r.lines[l.lineIndex]||"";l.lastTick+=i;let p=!1;for(;l.lastTick>=e&&l.typing;){l.lastTick-=e;const f=h[l.typedText.length];f!==void 0?(l.typedText+=f,be.textContent=l.typedText,p=!0):l.typing=!1}p&&te("dialog")}function S(){l.typing=!0,l.typedText="",l.lastTick=0,be.textContent="",te("dialog")}function A(){if(l.currentWaypoints.length){l.currentWaypoints[l.idx];{l.idx<l.currentWaypoints.length-1?d(l.idx+1):d(0);return}}}function V(){if(l.currentWaypoints.length){l.idx>0&&d(l.idx-1);return}}const K=document.getElementById("popup");document.getElementById("popup-backdrop"),document.getElementById("popup-title"),document.getElementById("popup-body"),document.getElementById("popup-close");function xe(i){we&&we.openPopup(i)}function ge(){we&&we.closeAll()}document.querySelector(".btn.next").addEventListener("click",A),document.querySelector(".btn.prev").addEventListener("click",V),window.addEventListener("keydown",i=>{if(i.key==="Escape"&&!K.hidden){ge();return}["ArrowRight","Enter"," "].includes(i.key)&&(i.preventDefault(),A()),["ArrowLeft","Backspace"].includes(i.key)&&(i.preventDefault(),V())}),j.addEventListener("mousedown",i=>{if(window.__EDITOR_ACTIVE__){console.log("ðŸŽ¨ Editor activo - evento bloqueado");return}const{x:r,y:h}=ve(i.clientX,i.clientY),p=l.currentIcons[l.idx]||[];for(const f of p){const c=f.type||"icon",C=f.width||v,k=f.height||v,z=q(u.z),W=C/z,J=k/z;let oe=!1;if(c==="icon"){const ee=r-f.x,R=h-f.y,P=m;oe=ee*ee+R*R<=P*P}else if(c==="hotspot"||c==="image"){const ee=W*.5,R=J*.5;oe=r>=f.x-ee&&r<=f.x+ee&&h>=f.y-R&&h<=f.y+R}if(oe){xe(f);return}}for(let f=0;f<l.currentWaypoints.length;f++){const c=l.currentWaypoints[f],C=r-c.x,k=h-c.y;if(C*C+k*k<=s*s){d(f);return}}A()});function ve(i,r){if(!Y.currentMap)return{x:0,y:0};const h=j.getBoundingClientRect(),p=Math.min(_,window.devicePixelRatio||1),f=j.width/p,c=j.height/p,C=(i-h.left)/h.width*f,k=(r-h.top)/h.height*c,z=(C-f/2)/u.z+u.x,W=(k-c/2)/u.z+u.y;return{x:z,y:W}}const Ce=document.documentElement,ke=document.body,Fe=document.querySelector(".novela");function ot(i){Ce.style.setProperty("--fill-scale",i),ke.classList.toggle("overflow-lock",i>1),ke.style.background="#000",Fe==null||Fe.classList.add("full-bleed"),ze(),te("camera","elements","minimap","dialog")}window.LayoutFill={set(i){const r=Math.max(.8,Math.min(1.2,i/100));ot(r)},get(){const i=getComputedStyle(Ce).getPropertyValue("--fill-scale").trim();return Math.round(parseFloat(i)*1e3)/10}};function ze(){if(!Y.currentMap)return;const i=Y.currentMap.config.mapImage,r=Y.isMobile,h=Fe==null?void 0:Fe.classList.contains("full-bleed"),p=ae.getBoundingClientRect();let f,c;if(r||h?(f=Math.round(p.width),c=Math.max(Math.round(p.height),N)):(f=y,c=t),i.logicalW&&i.logicalH){const oe=i.logicalW/i.logicalH;if(r||h){const ee=f/oe,R=c*oe;ee<=c?c=Math.max(ee,N):f=Math.max(R,320)}}const C=et(f,c,r);f=C.width,c=C.height;let k=Math.min(_,window.devicePixelRatio||1);r&&L.MOBILE_OPTIMIZATIONS.maxDPR&&(k=Math.min(k,L.MOBILE_OPTIMIZATIONS.maxDPR));let z=Math.round(f*k),W=Math.round(c*k);const J=et(z,W,r);z=J.width,W=J.height,j.width=z,j.height=W,r||h?(j.style.width="100%",j.style.height="100%"):(j.style.width=f+"px",j.style.height=c+"px"),n.setTransform(k,0,0,k,0,0),O.w=j.width/k-32,te("camera","elements","dialog","minimap"),console.log("ðŸ–¼ï¸ Canvas configurado:",{logical:`${f}Ã—${c}`,physical:`${z}Ã—${W}`,dpr:k,pixels:(z*W).toLocaleString(),memory:`~${J.estimatedMemoryMB.toFixed(2)}MB`,adjusted:J.adjusted,device:r?"mobile":h?"desktop/full-bleed":"desktop/card"})}let Be,Re=0;const Ze=16,Ke=150;window.addEventListener("resize",()=>{if(performance.now()-Re<Ze){clearTimeout(Be),Be=setTimeout(()=>{ze(),Re=performance.now()},Ke);return}clearTimeout(Be),Be=setTimeout(()=>{ze(),Re=performance.now()},Ke)},{passive:!0});try{"ResizeObserver"in window&&ae&&new ResizeObserver(()=>{te("camera","elements","minimap");const r=performance.now();r-Re>Ze&&(ze(),Re=r)}).observe(ae)}catch(i){console.debug("ResizeObserver no disponible",i)}let je,Ue=!0;function Ee(i){Ee.prev||(Ee.prev=i);const r=i-Ee.prev;Ee.prev=i,x(i);let h=0,p=0;const f=u.x,c=u.y,C=u.z;window.__EDITOR_ACTIVE__?(u.x=Z.x,u.y=Z.y,u.z=Z.z):(u.x=w(u.x,Z.x,a),u.y=w(u.y,Z.y+h,a),u.z=w(u.z,Z.z+p,a));const k=Math.abs(u.x-f),z=Math.abs(u.y-c),W=Math.abs(u.z-C);k>.1||z>.1||W>.001?(de.cameraMoving=!0,te("camera","minimap")):de.cameraMoving=!1,F(r),Ne()?(T(),Xe()):U.skippedFrames++,Ae(i),Ue&&(je=requestAnimationFrame(Ee))}document.addEventListener("visibilitychange",()=>{document.hidden?(Ue=!1,cancelAnimationFrame(je)):(Ue=!0,Ee.prev=0,te("camera","elements","dialog","minimap"),je=requestAnimationFrame(Ee))});const Je=document.querySelector(".hamburger"),it=document.querySelector(".drawer-backdrop"),nt=document.getElementById("menu-puntos").querySelector(".drawer__close");Je.addEventListener("click",()=>{Je.getAttribute("aria-expanded")==="true"?re.closeDrawer():re.openDrawer()}),nt.addEventListener("click",()=>re.closeDrawer()),it.addEventListener("click",()=>re.closeDrawer()),(async function(){var h;(h=document.querySelector(".novela"))==null||h.classList.add("full-bleed"),window.LayoutFill.set(100),re=new st(Y,Ye,o),we=new rt;const r=Y.getCurrentPhaseMaps()[0];r&&await Se(r.id),ze(),U.lastFpsUpdate=performance.now(),requestAnimationFrame(Ee)})()})();(function(){const t=()=>{Oe(),window.addEventListener("resize",Oe,{passive:!0})};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t,{once:!0}):t()})();(function(){const t=()=>{Oe(),window.addEventListener("resize",Oe,{passive:!0})};document.readyState==="loading"?document.addEventListener("DOMContentLoaded",t,{once:!0}):t()})();function ct(){try{return performance&&performance.memory?performance.memory:null}catch{return null}}if($e.debug){const y=ct();y&&tt.info("Mem MB",Math.round(y.usedJSHeapSize/1048576))}document.addEventListener("DOMContentLoaded",()=>{console.log(`
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘  ðŸŽ¨ EDITOR PRO - ADVANCED                               â•‘
â•‘  E = Toggle | Ctrl+Z = Undo | Ctrl+Y = Redo            â•‘
â•‘  Ctrl+D = Duplicate | Ctrl+C = Copy | Ctrl+V = Paste   â•‘
â•‘  H = Hide UI | F = Focus Item | Ctrl+S = Save Preset   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  `);const y=document.getElementById("mapa-canvas");if(!y)return;const t=y.getContext("2d"),e={active:!1,selectedItem:null,selectedItems:new Set,mode:null,corner:null,dragStart:{x:0,y:0},itemStart:{x:0,y:0,width:0,height:0,rotation:0},camera:{x:0,y:0,z:1},waypoint:null,items:[],waypointIndex:0,showGrid:!0,showRulers:!0,gridSnap:!1,gridSize:10,needsRedraw:!0,uiCollapsed:!1,isMobile:window.matchMedia("(max-width: 899px)").matches,editWaypointMode:!1,history:[],historyIndex:-1,maxHistory:50,clipboard:null,presets:q()};window.__EDITOR_ACTIVE__=!1;function a(o="edit"){if(!e.selectedItem)return;const d={action:o,timestamp:Date.now(),waypointIndex:e.waypointIndex,itemIndex:e.selectedItem.index,item:JSON.parse(JSON.stringify(e.items[e.selectedItem.index]))};e.historyIndex<e.history.length-1&&(e.history=e.history.slice(0,e.historyIndex+1)),e.history.push(d),e.history.length>e.maxHistory?e.history.shift():e.historyIndex++,v()}function s(){if(e.historyIndex<=0){console.log("âš ï¸ No hay mÃ¡s acciones para deshacer");return}e.historyIndex--;const o=e.history[e.historyIndex];if(o.waypointIndex===e.waypointIndex){const d=e.items[o.itemIndex];Object.assign(d,o.item),e.selectedItem={item:d,index:o.itemIndex},$(),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw")),console.log("â†¶ Undo:",o.action),v()}}function m(){if(e.historyIndex>=e.history.length-1){console.log("âš ï¸ No hay mÃ¡s acciones para rehacer");return}e.historyIndex++;const o=e.history[e.historyIndex];if(o.waypointIndex===e.waypointIndex){const d=e.items[o.itemIndex];Object.assign(d,o.item),e.selectedItem={item:d,index:o.itemIndex},$(),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw")),console.log("â†· Redo:",o.action),v()}}function v(){const o=document.getElementById("undo-btn"),d=document.getElementById("redo-btn");o&&(o.disabled=e.historyIndex<=0,o.style.opacity=o.disabled?"0.3":"1"),d&&(d.disabled=e.historyIndex>=e.history.length-1,d.style.opacity=d.disabled?"0.3":"1")}function O(){if(!e.selectedItem){console.log("âš ï¸ No hay item seleccionado para copiar");return}const o=e.items[e.selectedItem.index];e.clipboard=JSON.parse(JSON.stringify(o)),console.log("ðŸ“‹ Item copiado:",e.clipboard.type||"hotspot"),X()}function _(){if(!e.clipboard){console.log("âš ï¸ Clipboard vacÃ­o");return}const o=JSON.parse(JSON.stringify(e.clipboard));o.x+=20,o.y+=20,e.items.push(o),e.selectedItem={item:o,index:e.items.length-1},$(),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw")),console.log("ðŸ“Œ Item pegado"),a("paste")}function N(){if(!e.selectedItem){console.log("âš ï¸ No hay item seleccionado para duplicar");return}const o=e.items[e.selectedItem.index],d=JSON.parse(JSON.stringify(o));d.x+=30,d.y+=30,e.items.push(d),e.selectedItem={item:d,index:e.items.length-1},$(),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw")),console.log("ðŸ”„ Item duplicado"),a("duplicate")}function X(){const o=document.getElementById("paste-btn");o&&(o.disabled=!e.clipboard,o.style.opacity=o.disabled?"0.3":"1")}function q(){try{const o=localStorage.getItem("editor-presets");return o?JSON.parse(o):{}}catch{return{}}}function ae(){try{localStorage.setItem("editor-presets",JSON.stringify(e.presets))}catch(o){console.warn("âš ï¸ No se pudo guardar preset:",o)}}function j(){if(!e.selectedItem){console.log("âš ï¸ No hay item seleccionado");return}const o=prompt("Nombre del preset:",`preset_${Date.now()}`);if(!o)return;const d=e.items[e.selectedItem.index];e.presets[o]={width:d.width,height:d.height,rotation:d.rotation||0,type:d.type||"hotspot"},ae(),se(),console.log("ðŸ’¾ Preset guardado:",o)}function n(o){if(!e.selectedItem||!e.presets[o])return;const d=e.presets[o],E=e.items[e.selectedItem.index];E.width=d.width,E.height=d.height,E.rotation=d.rotation,$(),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw")),console.log("ðŸ“¥ Preset aplicado:",o),a("load-preset")}function fe(o){confirm(`Â¿Eliminar preset "${o}"?`)&&(delete e.presets[o],ae(),se(),console.log("ðŸ—‘ï¸ Preset eliminado:",o))}function se(){const o=document.getElementById("presets-list");if(!o)return;const d=Object.keys(e.presets);if(d.length===0){o.innerHTML='<div style="color:#666;font-size:10px;text-align:center;padding:8px;">No hay presets guardados</div>';return}o.innerHTML=d.map(E=>{const w=e.presets[E];return`
        <div style="display:flex;align-items:center;gap:4px;padding:4px;background:rgba(255,255,255,0.05);border-radius:4px;margin-bottom:4px;">
          <button class="preset-load-btn" data-preset="${E}" style="flex:1;padding:4px 6px;background:#00BFFF;border:none;border-radius:4px;cursor:pointer;font-size:10px;color:#000;font-weight:bold;">
            ${E}
          </button>
          <button class="preset-delete-btn" data-preset="${E}" style="padding:4px 6px;background:rgba(255,0,0,0.3);border:none;border-radius:4px;cursor:pointer;font-size:10px;color:#fff;">
            Ã—
          </button>
        </div>
        <div style="font-size:9px;color:#666;margin-bottom:6px;padding-left:4px;">
          ${w.width}Ã—${w.height} | ${w.rotation}Â° | ${w.type}
        </div>
      `}).join(""),o.querySelectorAll(".preset-load-btn").forEach(E=>{E.addEventListener("click",()=>n(E.dataset.preset))}),o.querySelectorAll(".preset-delete-btn").forEach(E=>{E.addEventListener("click",()=>fe(E.dataset.preset))})}function be(){if(!e.selectedItem){console.log("âš ï¸ No hay item seleccionado");return}const o=e.items[e.selectedItem.index];window.dispatchEvent(new CustomEvent("editor:focusItem",{detail:{x:o.x,y:o.y}})),console.log("ðŸŽ¯ Focus en item:",e.selectedItem.index)}function Y(){var M,I,T;const o=document.getElementById("waypoint-selector-panel");o&&o.remove();const d=document.createElement("div");d.id="waypoint-selector-panel",d.style.cssText=`
      position: fixed;
      ${e.isMobile?"bottom: 20px; left: 50%; transform: translateX(-50%);":"top: 80px; left: 20px;"}
      background: rgba(0, 0, 0, 0.95);
      padding: ${e.isMobile?"12px":"15px"};
      border-radius: 8px;
      border: 2px solid #FF00FF;
      z-index: 10001;
      font-family: monospace;
      color: white;
      ${e.isMobile?"width: 90%; max-width: 400px;":"min-width: 250px;"}
      box-shadow: 0 4px 20px rgba(255, 0, 255, 0.3);
      max-height: ${e.isMobile?"60vh":"80vh"};
      overflow-y: auto;
    `;const E=document.createElement("div");E.style.cssText=`
      color: #FF00FF;
      font-weight: bold;
      margin-bottom: 10px;
      font-size: ${e.isMobile?"14px":"16px"};
      text-align: center;
    `,E.textContent="ðŸ“ Seleccionar Waypoint";const w=document.createElement("div");w.style.cssText=`
      display: flex;
      flex-direction: column;
      gap: 6px;
    `;const g=((T=(I=(M=window.mapManager)==null?void 0:M.currentMap)==null?void 0:I.waypoints)==null?void 0:T.length)??0;Array.from({length:g},(F,S)=>S).forEach(F=>{const S=document.createElement("button");S.textContent=`Waypoint #${F+1}`,S.style.cssText=`
        background: ${e.waypointIndex===F?"rgba(255, 0, 255, 0.3)":"rgba(255, 255, 255, 0.1)"};
        border: 2px solid ${e.waypointIndex===F?"#FF00FF":"rgba(255, 255, 255, 0.3)"};
        color: white;
        padding: ${e.isMobile?"10px":"12px"};
        border-radius: 6px;
        cursor: pointer;
        font-family: monospace;
        font-size: ${e.isMobile?"13px":"14px"};
        transition: all 0.2s;
        font-weight: ${e.waypointIndex===F?"bold":"normal"};
      `,S.onmouseover=()=>{e.waypointIndex!==F&&(S.style.background="rgba(255, 255, 255, 0.2)",S.style.borderColor="rgba(255, 255, 255, 0.5)")},S.onmouseout=()=>{e.waypointIndex!==F&&(S.style.background="rgba(255, 255, 255, 0.1)",S.style.borderColor="rgba(255, 255, 255, 0.3)")},S.onclick=()=>{e.waypointIndex=F,window.dispatchEvent(new CustomEvent("editor:getWaypointData",{detail:{waypointIndex:F}})),window.addEventListener("editor:waypointDataResponse",function V(K){window.removeEventListener("editor:waypointDataResponse",V);const{waypoint:xe,items:ge,camera:ve}=K.detail;e.waypoint=xe,e.items=ge,e.camera=ve,e.selectedItem=null,B(`Waypoint #${F} cargado<br>${ge.length} items`),$(),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw"))},{once:!0}),w.querySelectorAll("button").forEach((V,K)=>{V.style.background=K===F?"rgba(255, 0, 255, 0.3)":"rgba(255, 255, 255, 0.1)",V.style.borderColor=K===F?"#FF00FF":"rgba(255, 255, 255, 0.3)",V.style.fontWeight=K===F?"bold":"normal"});const A=document.getElementById("waypoint-selector-btn");A&&(A.textContent=`ðŸ“ Waypoint #${F}`),console.log(`%cðŸ“ Waypoint cambiado a: #${F}`,"color:#FF00FF;font-weight:bold;font-size:14px")},w.appendChild(S)});const D=document.createElement("button");D.textContent="âœ• Cerrar",D.style.cssText=`
      width: 100%;
      padding: ${e.isMobile?"10px":"12px"};
      margin-top: 10px;
      background: rgba(255, 0, 0, 0.3);
      border: 2px solid rgba(255, 0, 0, 0.5);
      color: white;
      border-radius: 6px;
      cursor: pointer;
      font-family: monospace;
      font-size: ${e.isMobile?"13px":"14px"};
      font-weight: bold;
    `,D.onclick=()=>{d.remove()},d.appendChild(E),d.appendChild(w),d.appendChild(D),document.body.appendChild(d)}const re=o=>Math.sqrt(o);function we(o,d=36){(!Number.isFinite(o.width)||o.width<=0)&&(o.width=d),(!Number.isFinite(o.height)||o.height<=0)&&(o.height=d)}function l(o){const d=re(e.camera.z);return{width:(o.width||36)/d,height:(o.height||36)/d}}function u(o,d){return Math.round(o/d)*d}function Z(){var o,d,E;return(E=(d=(o=window.mapManager)==null?void 0:o.currentMap)==null?void 0:d.config)!=null&&E.mapImage?{w:window.mapManager.currentMap.config.mapImage.logicalW||2858,h:window.mapManager.currentMap.config.mapImage.logicalH||1761}:{w:2858,h:1761}}function de(){if(!e.active||!e.needsRedraw)return;const o=Math.min(2,window.devicePixelRatio||1),d=y.width/o,E=y.height/o;t.save(),t.translate(d/2,E/2),t.scale(e.camera.z,e.camera.z),t.translate(-e.camera.x,-e.camera.y),e.selectedItem&&(te(),Xe()),t.restore(),e.needsRedraw=!1}function te(){const o=e.items[e.selectedItem.index];if(!o)return;we(o);const{width:d,height:E}=l(o),w=d/2,g=E/2,x=e.camera;t.strokeStyle="#00FF00",t.lineWidth=3/x.z,t.setLineDash([10/x.z,5/x.z]),o.rotation?(t.save(),t.translate(o.x,o.y),t.rotate(o.rotation*Math.PI/180),t.strokeRect(-w,-g,d,E),t.restore()):t.strokeRect(o.x-w,o.y-g,d,E),t.setLineDash([]);const D=14/x.z;t.fillStyle="#00FF00",t.strokeStyle="#000",t.lineWidth=2/x.z,[{x:o.x-w,y:o.y-g},{x:o.x+w,y:o.y-g},{x:o.x-w,y:o.y+g},{x:o.x+w,y:o.y+g}].forEach(F=>{t.fillRect(F.x-D/2,F.y-D/2,D,D),t.strokeRect(F.x-D/2,F.y-D/2,D,D)});const I=o.y-g-35/x.z;t.beginPath(),t.arc(o.x,I,D/2,0,Math.PI*2),t.fillStyle="#FFD700",t.fill(),t.strokeStyle="#000",t.lineWidth=2/x.z,t.stroke(),t.beginPath(),t.moveTo(o.x,o.y-g),t.lineTo(o.x,I),t.strokeStyle="#FFD700",t.lineWidth=2/x.z,t.setLineDash([6/x.z,4/x.z]),t.stroke(),t.setLineDash([]);const T=8/x.z;t.strokeStyle="#FF00FF",t.lineWidth=2/x.z,t.beginPath(),t.moveTo(o.x-T,o.y),t.lineTo(o.x+T,o.y),t.moveTo(o.x,o.y-T),t.lineTo(o.x,o.y+T),t.stroke()}function Xe(){const o=e.items[e.selectedItem.index];if(!o||!e.waypoint)return;const d=e.camera,E=Math.round(o.x-e.waypoint.x),w=Math.round(o.y-e.waypoint.y),{width:g}=l(o),x=o.y-g/2-50/d.z,D=`(${E}, ${w}) | ${Math.round(o.width)}Ã—${Math.round(o.height)} | ${o.rotation||0}Â°`,M=14/d.z;t.font=`bold ${M}px monospace`;const I=t.measureText(D),T=8/d.z;t.fillStyle="rgba(0, 0, 0, 0.9)",t.fillRect(o.x-I.width/2-T,x-M-T,I.width+T*2,M+T*2),t.strokeStyle="#00FF00",t.lineWidth=2/d.z,t.strokeRect(o.x-I.width/2-T,x-M-T,I.width+T*2,M+T*2),t.fillStyle="#00FF00",t.textAlign="center",t.textBaseline="top",t.fillText(D,o.x,x-M)}function Ne(){var w,g,x,D,M,I,T,F;const o=document.createElement("div");o.id="editor-pro-ui",o.className=e.isMobile?"editor-mobile":"",o.style.cssText=`
      position: fixed;
      ${e.isMobile?"bottom: 10px; left: 10px; right: 10px;":"top: 140px; left: 20px;"}
      background: rgba(0, 0, 0, 0.95);
      color: #00FF00;
      padding: ${e.isMobile?"12px":"20px"};
      border-radius: 12px;
      font-family: monospace;
      font-size: ${e.isMobile?"11px":"13px"};
      z-index: 10000;
      border: 3px solid #00FF00;
      max-width: ${e.isMobile?"none":"360px"};
      max-height: ${e.isMobile?"60vh":"80vh"};
      overflow-y: auto;
      transition: transform 0.3s ease;
    `,o.innerHTML=`
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
        <div style="font-weight: bold; font-size: ${e.isMobile?"14px":"16px"}; color: #FFD700;">
          ðŸŽ¨ EDITOR ADVANCED
        </div>
        ${e.isMobile?`
          <button id="toggle-ui-collapse" style="
            padding: 4px 8px;
            background: #FFD700;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            font-size: 11px;
          ">
            ${e.uiCollapsed?"â–²":"â–¼"}
          </button>
        `:""}
      </div>

      <div id="editor-content" style="display: ${e.uiCollapsed?"none":"block"};">
        
        <!-- ðŸ†• BARRA DE ACCIONES -->
        <div style="display: grid; grid-template-columns: repeat(${e.isMobile?"2":"3"}, 1fr); gap: 6px; margin-bottom: 12px;">
          <button id="undo-btn" title="Undo (Ctrl+Z)" style="padding: 6px; background: #666; border: none; border-radius: 6px; cursor: pointer; font-size: 10px; color: #fff;">
            â†¶ Undo
          </button>
          <button id="redo-btn" title="Redo (Ctrl+Y)" style="padding: 6px; background: #666; border: none; border-radius: 6px; cursor: pointer; font-size: 10px; color: #fff;">
            â†· Redo
          </button>
          <button id="duplicate-btn" title="Duplicate (Ctrl+D)" style="padding: 6px; background: #9C27B0; border: none; border-radius: 6px; cursor: pointer; font-size: 10px; color: #fff;">
            ðŸ”„ Dup
          </button>
          <button id="copy-btn" title="Copy (Ctrl+C)" style="padding: 6px; background: #2196F3; border: none; border-radius: 6px; cursor: pointer; font-size: 10px; color: #fff;">
            ðŸ“‹ Copy
          </button>
          <button id="paste-btn" title="Paste (Ctrl+V)" style="padding: 6px; background: #4CAF50; border: none; border-radius: 6px; cursor: pointer; font-size: 10px; color: #fff;" disabled>
            ðŸ“Œ Paste
          </button>
          <button id="focus-btn" title="Focus (F)" style="padding: 6px; background: #FF9800; border: none; border-radius: 6px; cursor: pointer; font-size: 10px; color: #fff;">
            ðŸŽ¯ Focus
          </button>
        </div>

        <!-- ðŸ†• SELECTOR DE WAYPOINTS CON LISTA ACTUALIZADA -->
        <div style="margin-bottom: 12px; padding: 10px; background: rgba(255, 100, 255, 0.15); border-radius: 8px; border: 1px solid #FF00FF;">
          <button id="waypoint-selector-btn" style="width: 100%; padding: 8px; background: #FF00FF; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 11px; color: #fff;">
            ðŸ“ Waypoint #${e.waypointIndex}
          </button>
        </div>

        <!-- CONTROLES GRID/RULERS -->
        <div style="display: flex; gap: 8px; margin-bottom: 12px; flex-wrap: wrap;">
          <button id="toggle-grid" style="flex: 1; min-width: 80px; padding: 6px; background: #00FF00; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 10px;">
            GRID: ON
          </button>
          <button id="toggle-rulers" style="flex: 1; min-width: 80px; padding: 6px; background: #FFD700; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 10px;">
            RULERS: ON
          </button>
        </div>

        <div style="margin-bottom: 12px;">
          <label style="display: block; margin-bottom: 6px; font-size: 10px; color: #FFD700;">
            Grid Size: <span id="grid-size-value">10px</span>
          </label>
          <input 
            type="range" 
            id="grid-size" 
            min="5" 
            max="50" 
            value="10" 
            step="5"
            style="width: 100%; accent-color: #00FF00;"
          />
        </div>

        <!-- WAYPOINT TOOLS -->
        <div id="wp-tools" style="padding:10px;background:rgba(0,191,255,.08);border:1px solid #00BFFF;border-radius:8px;margin-bottom:12px;">
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <button id="toggle-wp-mode" style="padding:6px 8px;background:#00BFFF;border:none;border-radius:6px;color:#000;font-weight:700;cursor:pointer;">âœ¥ Editar Waypoint</button>
            <label style="font-size:11px;color:#00BFFF;">X: <input id="wp-x" type="number" class="prop-input" style="width:90px;"></label>
            <label style="font-size:11px;color:#00BFFF;">Y: <input id="wp-y" type="number" class="prop-input" style="width:90px;"></label>
            <label style="font-size:11px;color:#00BFFF;">Z: <input id="wp-z" type="number" step="0.01" class="prop-input" style="width:80px;"></label>
            <button id="save-wp" style="padding:6px 8px;background:#00FF88;border:none;border-radius:6px;color:#000;font-weight:700;cursor:pointer;">ðŸ’¾ Guardar</button>
          </div>
          <div style="font-size:10px;color:#7fd8ff;margin-top:6px;">Arrastra en canvas cuando â€œEditar Waypointâ€ estÃ© activo. Los valores son absolutos (px del mapa) y z es zoom.</div>
        </div>
        <!-- PROPIEDADES -->
        <div id="properties-panel" style="display: none; padding: 12px; background: rgba(0, 100, 255, 0.15); border-radius: 8px; border: 1px solid #00BFFF; margin-bottom: 12px;">
          <div style="font-size: 11px; color: #00BFFF; margin-bottom: 8px; font-weight: bold;">âœï¸ PROPIEDADES:</div>
          <div style="display: grid; grid-template-columns: ${e.isMobile?"1fr 1fr":"auto 1fr"}; gap: 6px; font-size: 11px;">
            <label>X:</label><input type="number" id="prop-x" class="prop-input">
            <label>Y:</label><input type="number" id="prop-y" class="prop-input">
            <label>W:</label><input type="number" id="prop-w" class="prop-input">
            <label>H:</label><input type="number" id="prop-h" class="prop-input">
            <label>Rot:</label><input type="number" id="prop-rot" class="prop-input">
          </div>
        </div>

        <!-- ðŸ†• PRESETS -->
        <div style="padding: 12px; background: rgba(255, 100, 0, 0.1); border-radius: 8px; border: 1px solid #FF6B00; margin-bottom: 12px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
            <div style="font-size: 11px; color: #FF6B00; font-weight: bold;">ðŸ’¾ PRESETS:</div>
            <button id="save-preset-btn" style="padding: 4px 8px; background: #FF6B00; border: none; border-radius: 4px; cursor: pointer; font-size: 10px; color: #fff;">
              Save
            </button>
          </div>
          <div id="presets-list" style="max-height: 120px; overflow-y: auto;"></div>
        </div>

        ${e.isMobile?"":`
        <div style="padding: 10px; background: rgba(0, 255, 0, 0.1); border-radius: 8px; border: 1px solid #00FF00; margin-bottom: 12px;">
          <div style="font-size: 10px; color: #FFD700; margin-bottom: 6px;">âŒ¨ï¸ SHORTCUTS:</div>
          <div style="font-size: 9px; line-height: 1.6; column-count: 2; column-gap: 10px;">
            <div>E = Toggle</div>
            <div>G = Grid</div>
            <div>R = Rulers</div>
            <div>H = Hide UI</div>
            <div>F = Focus</div>
            <div>Esc = Deselect</div>
            <div>â†‘â†“â†â†’ = Move</div>
            <div>Shift+Arrow = 10px</div>
            <div>[ ] = Rotate</div>
            <div>- + = Resize</div>
            <div>Ctrl+Z = Undo</div>
            <div>Ctrl+Y = Redo</div>
            <div>Ctrl+D = Duplicate</div>
            <div>Ctrl+C = Copy</div>
            <div>Ctrl+V = Paste</div>
            <div>Ctrl+S = Save Preset</div>
          </div>
        </div>
        `}

        <div id="editor-info" style="padding: 10px; background: rgba(255, 215, 0, 0.15); border-radius: 8px; border: 1px solid #FFD700; font-size: ${e.isMobile?"10px":"12px"}; color: #FFD700; line-height: 1.4;">
          No item selected
        </div>
      </div>
    `;const d=document.createElement("style");d.textContent=`
      .prop-input {
        width: 100%;
        padding: 4px;
        background: #111;
        color: #0FF;
        border: 1px solid #00BFFF;
        border-radius: 4px;
        font-size: 11px;
      }
      .prop-input:focus {
        outline: none;
        border-color: #00FF00;
        box-shadow: 0 0 4px rgba(0, 255, 255, 0.5);
      }
    `,document.head.appendChild(d),document.body.appendChild(o),(w=document.getElementById("undo-btn"))==null||w.addEventListener("click",s),(g=document.getElementById("redo-btn"))==null||g.addEventListener("click",m),(x=document.getElementById("duplicate-btn"))==null||x.addEventListener("click",N),(D=document.getElementById("copy-btn"))==null||D.addEventListener("click",O),(M=document.getElementById("paste-btn"))==null||M.addEventListener("click",_),(I=document.getElementById("focus-btn"))==null||I.addEventListener("click",be),(T=document.getElementById("save-preset-btn"))==null||T.addEventListener("click",j),(F=document.getElementById("waypoint-selector-btn"))==null||F.addEventListener("click",Y);const E=document.getElementById("toggle-ui-collapse");return E&&E.addEventListener("click",()=>{e.uiCollapsed=!e.uiCollapsed;const S=document.getElementById("editor-content"),A=document.getElementById("toggle-ui-collapse");e.uiCollapsed?(S.style.display="none",A.textContent="â–²"):(S.style.display="block",A.textContent="â–¼")}),document.getElementById("toggle-grid").addEventListener("click",()=>{e.showGrid=!e.showGrid;const S=document.getElementById("toggle-grid");S.textContent=`GRID: ${e.showGrid?"ON":"OFF"}`,S.style.background=e.showGrid?"#00FF00":"#333",e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw"))}),document.getElementById("toggle-rulers").addEventListener("click",()=>{e.showRulers=!e.showRulers;const S=document.getElementById("toggle-rulers"),A=document.getElementById("toggle-wp-mode"),V=document.getElementById("save-wp"),K=document.getElementById("wp-x"),xe=document.getElementById("wp-y"),ge=document.getElementById("wp-z");A&&A.addEventListener("click",()=>{e.editWaypointMode=!e.editWaypointMode,A.textContent=e.editWaypointMode?"âœ¥ Editando Waypointâ€¦":"âœ¥ Editar Waypoint",A.style.background=e.editWaypointMode?"#FFD700":"#00BFFF",e.waypoint&&(K.value=Math.round(e.waypoint.x),xe.value=Math.round(e.waypoint.y),ge.value=Number(e.waypoint.z||1).toFixed(2)),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw"))}),V&&V.addEventListener("click",()=>{if(!e.waypoint)return;const ve=parseInt(K.value)||e.waypoint.x,Ce=parseInt(xe.value)||e.waypoint.y,ke=parseFloat(ge.value)||e.waypoint.z||1;_e(ve,Ce,ke)}),S.textContent=`RULERS: ${e.showRulers?"ON":"OFF"}`,S.style.background=e.showRulers?"#FFD700":"#333",e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw"))})(function(){const A=document.getElementById("toggle-wp-mode"),V=document.getElementById("save-wp"),K=document.getElementById("wp-x"),xe=document.getElementById("wp-y"),ge=document.getElementById("wp-z");A&&A.addEventListener("click",()=>{e.editWaypointMode=!e.editWaypointMode,A.textContent=e.editWaypointMode?"âœ¥ Editando Waypointâ€¦":"âœ¥ Editar Waypoint",A.style.background=e.editWaypointMode?"#FFD700":"#00BFFF",e.waypoint&&(K.value=Math.round(e.waypoint.x),xe.value=Math.round(e.waypoint.y),ge.value=Number(e.waypoint.z||1).toFixed(2)),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw"))}),V&&V.addEventListener("click",()=>{if(!e.waypoint)return;const ve=parseInt(K.value)||e.waypoint.x,Ce=parseInt(xe.value)||e.waypoint.y,ke=parseFloat(ge.value)||e.waypoint.z||1;_e(ve,Ce,ke)})})(),document.getElementById("grid-size").addEventListener("input",S=>{e.gridSize=parseInt(S.target.value),document.getElementById("grid-size-value").textContent=`${e.gridSize}px`,e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw"))}),document.querySelectorAll(".prop-input").forEach(S=>{S.addEventListener("input",()=>{e.selectedItem&&He()})}),se(),v(),X(),o}function B(o){const d=document.getElementById("editor-info");d&&(d.innerHTML=o)}function $(){const o=document.getElementById("properties-panel");if(!e.selectedItem){o.style.display="none";return}o.style.display="block";const d=e.items[e.selectedItem.index],E=Math.round(d.x-e.waypoint.x),w=Math.round(d.y-e.waypoint.y);document.getElementById("prop-x").value=E,document.getElementById("prop-y").value=w,document.getElementById("prop-w").value=Math.round(d.width),document.getElementById("prop-h").value=Math.round(d.height),document.getElementById("prop-rot").value=Math.round(d.rotation||0)}function He(){if(!e.selectedItem)return;const o=e.items[e.selectedItem.index],d=parseInt(document.getElementById("prop-x").value)||0,E=parseInt(document.getElementById("prop-y").value)||0,w=parseInt(document.getElementById("prop-w").value)||36,g=parseInt(document.getElementById("prop-h").value)||36,x=parseInt(document.getElementById("prop-rot").value)||0;o.x=e.waypoint.x+d,o.y=e.waypoint.y+E,o.width=Math.max(10,w),o.height=Math.max(10,g),o.rotation=x%360,e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw")),Ye()}function _e(o,d,E=1){if(!e.waypoint)return;const{w,h:g}=Z(),x=Math.max(0,Math.min(1,o/w)),D=Math.max(0,Math.min(1,d/g)),M={xp:Number(x.toFixed(6)),yp:Number(D.toFixed(6)),z:Number((E||1).toFixed(2))};window.dispatchEvent(new CustomEvent("editor:updateWaypoint",{detail:{waypointIndex:e.waypointIndex,device:e.isMobile?"mobile":"desktop",values:M}})),window.dispatchEvent(new CustomEvent("editor:getWaypointData",{detail:{waypointIndex:e.waypointIndex}})),window.addEventListener("editor:waypointDataResponse",function I(T){window.removeEventListener("editor:waypointDataResponse",I);const{waypoint:F,items:S,camera:A}=T.detail;e.waypoint=F,e.items=S,e.camera=A,e.selectedItem=null,e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw")),B(`ðŸ’¾ Waypoint #${e.waypointIndex} guardado: (${Math.round(F.x)}, ${Math.round(F.y)}) z:${(F.z||1).toFixed(2)}`)},{once:!0})}function qe(){if(e.active=!e.active,window.__EDITOR_ACTIVE__=e.active,e.active)console.log("%cðŸŽ¨ EDITOR ACTIVADO","color:#00FF00;font-size:16px;font-weight:bold"),y.style.cursor="crosshair",Ne(),e.needsRedraw=!0;else{console.log("%câ¹ï¸  EDITOR DESACTIVADO","color:#FF6B6B;font-size:16px"),y.style.cursor="default";const o=document.getElementById("editor-pro-ui");o&&o.remove(),e.selectedItem=null}window.dispatchEvent(new CustomEvent("editor:redraw"))}window.addEventListener("keydown",o=>{var d,E,w;if(o.target.tagName==="INPUT"||o.target.tagName==="TEXTAREA"){o.key==="Escape"&&o.target.blur();return}if(o.key==="e"||o.key==="E"){qe(),o.preventDefault(),o.stopImmediatePropagation();return}if(e.active){if((o.ctrlKey||o.metaKey)&&o.key==="z"){s(),o.preventDefault();return}if((o.ctrlKey||o.metaKey)&&o.key==="y"){m(),o.preventDefault();return}if((o.ctrlKey||o.metaKey)&&o.key==="c"){O(),o.preventDefault();return}if((o.ctrlKey||o.metaKey)&&o.key==="v"){_(),o.preventDefault();return}if((o.ctrlKey||o.metaKey)&&o.key==="d"){N(),o.preventDefault();return}if((o.ctrlKey||o.metaKey)&&o.key==="s"){j(),o.preventDefault();return}if(o.key==="f"||o.key==="F"){be(),o.preventDefault();return}if((o.key==="g"||o.key==="G")&&((d=document.getElementById("toggle-grid"))==null||d.click(),o.preventDefault()),(o.key==="r"||o.key==="R")&&((E=document.getElementById("toggle-rulers"))==null||E.click(),o.preventDefault()),(o.key==="h"||o.key==="H")&&(e.isMobile&&((w=document.getElementById("toggle-ui-collapse"))==null||w.click()),o.preventDefault()),e.gridSnap=o.shiftKey,o.key==="Escape"&&e.selectedItem){e.selectedItem=null,B("No item selected"),$(),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw")),o.preventDefault();return}if((o.key==="Delete"||o.key==="Backspace")&&e.selectedItem){console.log("ðŸ—‘ï¸ Item eliminado"),e.selectedItem=null,$(),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw")),o.preventDefault();return}if(e.selectedItem&&["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(o.key)){const g=e.items[e.selectedItem.index],x=o.shiftKey?10:1;switch(o.key){case"ArrowUp":g.y-=x;break;case"ArrowDown":g.y+=x;break;case"ArrowLeft":g.x-=x;break;case"ArrowRight":g.x+=x;break}$(),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw")),a("move"),o.preventDefault();return}if(e.selectedItem&&(o.key==="["||o.key==="]")){const g=e.items[e.selectedItem.index],x=o.shiftKey?15:5;g.rotation=(g.rotation||0)+(o.key==="["?-x:x),g.rotation=g.rotation%360,$(),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw")),a("rotate"),o.preventDefault();return}if(e.selectedItem&&(o.key==="-"||o.key==="+"||o.key==="=")){const g=e.items[e.selectedItem.index],x=o.shiftKey?20:10,D=o.key==="-"?-x:x;g.width=Math.max(10,g.width+D),g.height=Math.max(10,g.height+D),$(),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw")),a("resize"),o.preventDefault();return}if(!o.ctrlKey&&!o.metaKey&&o.key>="0"&&o.key<="9"){const g=parseInt(o.key),x=e.isMobile?5:7;if(g<=x){e.waypointIndex=g,window.dispatchEvent(new CustomEvent("editor:getWaypointData",{detail:{waypointIndex:g}})),window.addEventListener("editor:waypointDataResponse",function I(T){window.removeEventListener("editor:waypointDataResponse",I);const{waypoint:F,items:S,camera:A}=T.detail;e.waypoint=F,e.items=S,e.camera=A,e.selectedItem=null,B(`Waypoint #${g} cargado<br>${S.length} items`),$(),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw"))},{once:!0});const D=document.getElementById("waypoint-selector-btn");D&&(D.textContent=`ðŸ“ Waypoint #${g}`);const M=e.isMobile?["ðŸ  Inicio","ðŸŒ³ DeforestaciÃ³n","ðŸŒ‹ VolcÃ¡n","ðŸ‘¥ Comunidad","ðŸ¦œ Biodiversidad","ðŸ”„ EconomÃ­a Circular"]:["ðŸ  Inicio","ðŸŒ³ DeforestaciÃ³n","ðŸŒ‹ VolcÃ¡n","âš¡ HidroelÃ©ctrica","ðŸ‘¥ Comunidad","ðŸ¦œ Biodiversidad","ðŸ­ Industria","ðŸ”„ EconomÃ­a Circular"];console.log(`%cðŸ“ Waypoint cambiado a: #${g} - ${M[g]||""}`,"color:#FF00FF;font-weight:bold;font-size:14px")}return}}},!0),window.addEventListener("keyup",o=>{e.gridSnap=o.shiftKey}),window.addEventListener("editor:mapCoordsResponse",o=>{if(!e.active)return;const{camera:d,items:E,waypoint:w,waypointIndex:g}=o.detail;e.camera=d,e.items=E,e.waypoint=w,e.waypointIndex=g,e.needsRedraw=!0}),window.addEventListener("editor:redraw",()=>{e.active&&requestAnimationFrame(de)}),y.addEventListener("mousedown",U,{capture:!0}),y.addEventListener("mousemove",Ae,{capture:!0}),window.addEventListener("mouseup",Se,{capture:!0});function U(o){e.active&&(o.stopImmediatePropagation(),o.preventDefault(),window.dispatchEvent(new CustomEvent("editor:getMapCoords",{detail:{clientX:o.clientX,clientY:o.clientY}})),window.addEventListener("editor:mapCoordsResponse",function d(E){window.removeEventListener("editor:mapCoordsResponse",d);const{x:w,y:g}=E.detail,x=e.camera,D=15/x.z;if(e.selectedItem){const M=e.items[e.selectedItem.index];if(M){we(M);const{width:I,height:T}=l(M),F=I/2,S=T/2,A=M.y-S-35/x.z;if(Math.hypot(w-M.x,g-A)<D){e.mode="rotate",e.dragStart={x:w,y:g},e.itemStart={...M},y.style.cursor="grabbing";return}const V=[{x:M.x-F,y:M.y-S,name:"tl"},{x:M.x+F,y:M.y-S,name:"tr"},{x:M.x-F,y:M.y+S,name:"bl"},{x:M.x+F,y:M.y+S,name:"br"}];for(const K of V)if(Math.hypot(w-K.x,g-K.y)<D){e.mode="resize",e.corner=K.name,e.dragStart={x:w,y:g},e.itemStart={...M},y.style.cursor="nwse-resize";return}if(w>=M.x-F&&w<=M.x+F&&g>=M.y-S&&g<=M.y+S){e.mode="drag",e.dragStart={x:w,y:g},e.itemStart={...M},y.style.cursor="move";return}}}for(let M=e.items.length-1;M>=0;M--){const I=e.items[M];we(I);const{width:T,height:F}=l(I),S=T/2,A=F/2;if(w>=I.x-S&&w<=I.x+S&&g>=I.y-A&&g<=I.y+A){e.selectedItem={item:I,index:M},e.mode="drag",e.dragStart={x:w,y:g},e.itemStart={...I},y.style.cursor="move";const V=Math.round(I.x-e.waypoint.x),K=Math.round(I.y-e.waypoint.y);console.log(`%cðŸ“ Item #${M}`,"color:#00FF00;font-weight:bold"),console.table({index:M,type:I.type||"hotspot",offsetX:V,offsetY:K,width:Math.round(I.width),height:Math.round(I.height),rotation:I.rotation||0}),B(`
            <b style="color:#00FF00;">Item #${M}</b><br>
            Type: ${I.type||"hotspot"}<br>
            Offset: (${V}, ${K})<br>
            Size: ${Math.round(I.width)}Ã—${Math.round(I.height)}<br>
            Rotation: ${I.rotation||0}Â°
          `),$(),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw"));return}}e.selectedItem=null,e.mode=null,y.style.cursor="crosshair",B("No item selected"),$(),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw"))},{once:!0}))}function Ae(o){!e.active||!e.mode||(o.stopImmediatePropagation(),o.preventDefault(),window.dispatchEvent(new CustomEvent("editor:getMapCoords",{detail:{clientX:o.clientX,clientY:o.clientY}})),window.addEventListener("editor:mapCoordsResponse",function d(E){window.removeEventListener("editor:mapCoordsResponse",d);let{x:w,y:g}=E.detail;if(e.editWaypointMode&&e.mode==="drag-wp"&&e.waypoint){e.gridSnap&&(w=u(w,e.gridSize),g=u(g,e.gridSize)),e.waypoint.x=e.itemStart.x+(w-e.dragStart.x),e.waypoint.y=e.itemStart.y+(g-e.dragStart.y);const I=document.getElementById("wp-x"),T=document.getElementById("wp-y");I&&(I.value=Math.round(e.waypoint.x)),T&&(T.value=Math.round(e.waypoint.y)),B(`<b style="color:#00BFFF;">Waypoint #${e.waypointIndex}</b><br>Pos: (${Math.round(e.waypoint.x)}, ${Math.round(e.waypoint.y)})  Z:${(e.waypoint.z||1).toFixed(2)}${e.gridSnap?'<br><b style="color:#FFD700;">ðŸ”’ SNAP</b>':""}`),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw"));return}const x=e.selectedItem.item;if(e.gridSnap&&(w=u(w,e.gridSize),g=u(g,e.gridSize)),e.mode==="drag"){const I=w-e.dragStart.x,T=g-e.dragStart.y;x.x=e.itemStart.x+I,x.y=e.itemStart.y+T}else if(e.mode==="resize"){const I=w-e.dragStart.x,T=g-e.dragStart.y;let F=e.itemStart.width,S=e.itemStart.height,A=e.itemStart.x,V=e.itemStart.y;e.corner.includes("r")&&(F=Math.max(20,e.itemStart.width+I*2)),e.corner.includes("l")&&(F=Math.max(20,e.itemStart.width-I*2),A=e.itemStart.x+I),e.corner.includes("b")&&(S=Math.max(20,e.itemStart.height+T*2)),e.corner.includes("t")&&(S=Math.max(20,e.itemStart.height-T*2),V=e.itemStart.y+T),x.width=Math.round(F),x.height=Math.round(S),x.x=A,x.y=V}else if(e.mode==="rotate"){const I=Math.atan2(g-e.itemStart.y,w-e.itemStart.x)*(180/Math.PI);x.rotation=Math.round(I+90)}const D=Math.round(x.x-e.waypoint.x),M=Math.round(x.y-e.waypoint.y);B(`
        <b style="color:#00FF00;">Item #${e.selectedItem.index}</b><br>
        Type: ${x.type||"hotspot"}<br>
        Offset: (${D}, ${M})<br>
        Size: ${Math.round(x.width)}Ã—${Math.round(x.height)}<br>
        Rotation: ${x.rotation||0}Â°
        ${e.gridSnap?'<br><b style="color:#FFD700;">ðŸ”’ SNAP</b>':""}
      `),$(),e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw"))},{once:!0}))}function Se(o){e.active&&(o.stopImmediatePropagation(),o.preventDefault(),e.mode==="drag-wp"?a("move-waypoint"):e.selectedItem&&e.mode&&(a(e.mode),Ye()),e.mode=null,e.corner=null,y.style.cursor=e.active?"crosshair":"default",e.needsRedraw=!0,window.dispatchEvent(new CustomEvent("editor:redraw")))}function Ye(){window.dispatchEvent(new CustomEvent("editor:getItemCode",{detail:{waypointIndex:e.waypointIndex,itemIndex:e.selectedItem.index}})),window.addEventListener("editor:itemCodeResponse",function o(d){window.removeEventListener("editor:itemCodeResponse",o);const{code:E}=d.detail;console.log("%câœ… CÃ³digo actualizado:","color:#00FF00;font-size:14px;font-weight:bold"),console.log(E)},{once:!0})}y.addEventListener("touchstart",o=>{if(!e.active)return;o.preventDefault();const d=o.touches[0];U(new MouseEvent("mousedown",{bubbles:!0,clientX:d.clientX,clientY:d.clientY}))},{capture:!0,passive:!1}),y.addEventListener("touchmove",o=>{if(!e.active||!e.selectedItem)return;o.preventDefault();const d=o.touches[0];Ae(new MouseEvent("mousemove",{bubbles:!0,clientX:d.clientX,clientY:d.clientY}))},{capture:!0,passive:!1}),y.addEventListener("touchend",o=>{e.active&&(o.preventDefault(),Se(new MouseEvent("mouseup",{bubbles:!0})))},{capture:!0}),console.log('âœ… Editor Pro Advanced cargado. Presiona "E"')});

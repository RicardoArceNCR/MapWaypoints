<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="description" content="Mapa interactivo multi-fase que narra un viaje a través de puntos clave, con zooms, hotspots y contenido narrativo.">
  <meta name="color-scheme" content="dark light">
  <!-- Content Security Policy: Configuración para desarrollo -->
  <!-- 
    DESARROLLO: Incluye 'unsafe-inline' y 'unsafe-eval' para Vite HMR y debugging
    PRODUCCIÓN: Remover 'unsafe-eval' y minimizar 'unsafe-inline' usando nonces/hashes
    
    Directivas actuales:
    - script-src: Permite módulos ES6 y eval para Vite dev server
    - style-src: Permite estilos inline (componentes dinámicos)
    - connect-src: Permite WebSocket para HMR (ws:/wss:)
    - img-src: Permite data URIs y blobs para imágenes dinámicas
  -->
  <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; font-src 'self' data:; img-src 'self' data: blob:; connect-src 'self' ws: wss:;">
  <title>Mapa Interactivo Multi-Fase</title>
  <link rel="preload" href="/assets/fonts/inter-v20-latin-regular.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/assets/fonts/inter-v20-latin-600.woff2" as="font" type="font/woff2" crossorigin>
  <!-- <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"> -->
  <link rel="stylesheet" href="./style.css">
  <link rel="stylesheet" href="./popup_styles.css">
  <link rel="preload" href="../assets/mapa-mobile.webp"  as="image" type="image/webp" media="(max-width: 899px)">
  <link rel="preload" href="../assets/mapa-dektop.webp" as="image" type="image/webp" media="(min-width: 900px)">

  

  <style>
  body, html {
    margin: 0;
    padding: 0;
    overflow: hidden;
    background: #000;
    font-family: 'Inter', sans-serif;
  }

  #mapa-canvas-wrapper {
    width: 100vw;
    height: 100%;
    position: relative;
  }

  .loading-spinner {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    color: white;
  }

  canvas {
    display: block;
    position: absolute;
    top: 0;
    left: 0;
  }
</style>


</head>
<body>
  <a class="skip-link" href="#main-content">Saltar al contenido principal</a>

  <header class="top-bar" role="banner">
    <!-- Filtro de fases (Desktop) -->
    <div class="phase-filter" id="phase-filter" role="group" aria-label="Filtro de fases"></div>
    
    <!-- Selector de mapas -->
    <div class="map-selector-wrapper" id="map-selector"></div>
  </header>

  <main id="main-content" role="main" tabindex="-1">
    <div id="mapa-canvas-wrapper" class="novela" data-phase="fase1">

    <!-- Botón hamburguesa (Mobile) -->
    <button class="hamburger" aria-label="Abrir menú" aria-controls="menu-puntos" aria-expanded="false">
      ☰
    </button>

    <!-- Drawer/Menú lateral -->
    <nav id="menu-puntos" class="drawer" aria-hidden="true">
      <header class="drawer__head">
        <strong>Puntos del mapa</strong>
        <button class="drawer__close" aria-label="Cerrar menú">×</button>
      </header>
      <ol class="drawer__list" id="drawer-list"></ol>
    </nav>

    <!-- Backdrop del drawer -->
    <div class="drawer-backdrop" hidden></div>

    <!-- Capa DOM para overlays -->
    <div id="overlay-layer" class="overlay-root" aria-hidden="true"></div>

    <!-- Canvas principal -->
    <canvas id="mapa-canvas" width="1280" height="920" aria-label="Mapa interactivo"></canvas>

    <!-- Canvas overlay del editor (no recibe eventos) -->
    <canvas id="editor-layer" width="1280" height="920" aria-hidden="true"></canvas>

    <!-- Loading spinner -->
    <div id="loading-spinner" class="loading-spinner" hidden>
      <svg viewBox="0 0 50 50" class="spinner-svg" aria-hidden="true">
        <circle class="ring" cx="25" cy="25" r="20"></circle>
        <circle class="dot" cx="25" cy="5" r="3"></circle>
      </svg>
      <div class="loading-text">Cargando…</div>
    </div>

    <!-- Controles de navegación -->
    <div class="ui" aria-label="Controles de navegación">
      <button class="btn prev" aria-label="Anterior" title="Anterior (◀)">◀</button>
      <div class="progress" aria-hidden="true"></div>
      <button class="btn next" aria-label="Siguiente" title="Siguiente (▶)">▶</button>
    </div>

    <!-- Minimap -->
    <canvas id="minimap" width="200" height="120" aria-hidden="true"></canvas>

    <!-- Popup modal backdrop -->
    <div id="popup-backdrop" class="popup-backdrop" hidden></div>
    
    <!-- Popup modal - Estructura simple (por defecto) -->
    <div id="popup" class="popup popup-simple" role="dialog" aria-modal="true" aria-labelledby="popup-title" hidden>
      <button id="popup-close" class="popup-close" aria-label="Cerrar">×</button>
      <h3 id="popup-title"></h3>
      <div id="popup-body"></div>
    </div>

    <!-- Popup modal - Estructura detallada mejorada -->
    <div id="popup-detailed" class="popup popup-detailed" role="dialog" aria-modal="true" aria-labelledby="popup-detailed-title" hidden>
      <!-- Handle para arrastrar en móvil -->
      <div class="popup-detailed__drag-handle" aria-hidden="true"></div>
      
      <!-- Botón de cerrar -->
      <button id="popup-detailed-close" class="popup-close" aria-label="Cerrar">×</button>
      
      <!-- Imagen principal con overlay -->
      <div class="popup-detailed__image-wrapper">
        <img 
          id="popup-detailed-image" 
          class="popup-detailed__image" 
          alt="" 
          loading="lazy" 
          decoding="async"
        />
      </div>
      
      <!-- Contenido principal con scroll -->
      <div class="popup-detailed__content">
        <!-- Título -->
        <h3 id="popup-detailed-title" class="popup-detailed__title"></h3>
        
        <!-- Fecha y hora -->
        <div class="popup-detailed__datetime">
          <span id="popup-detailed-date" class="popup-detailed__date"></span>
          <span id="popup-detailed-time" class="popup-detailed__time"></span>
        </div>
        
        <!-- Ubicación con ícono -->
        <div id="popup-detailed-location" class="popup-detailed__location"></div>
        
        <!-- Descripción -->
        <div id="popup-detailed-description" class="popup-detailed__description"></div>
        
        <!-- Sección de implicados -->
        <div id="popup-detailed-involved-section" class="popup-detailed__involved-section" hidden>
          <div class="popup-detailed__section-divider"></div>
          <h4 class="popup-detailed__section-title">Implicados</h4>
          <div id="popup-detailed-involved" class="popup-detailed__involved"></div>
        </div>
        
        <!-- Sección de echos -->
        <div id="popup-detailed-echos-section" class="popup-detailed__echos-section" hidden>
          <div class="popup-detailed__section-divider"></div>
          <h4 id="popup-detailed-echos-title" class="popup-detailed__section-title"></h4>
          <div id="popup-detailed-echos" class="popup-detailed__echos"></div>
        </div>
      </div>
    </div>

    <!-- Screen reader live region -->
    <div class="sr-live" aria-live="polite"></div>
  </div>
  </main>

  <!-- Contenedor donde el editor se monta -->
  <div id="editor-layer" aria-hidden="true"></div>

  <!-- ÚNICO script de entrada -->
  <script type="module" src="/app.js"></script>

</body>
</html>
